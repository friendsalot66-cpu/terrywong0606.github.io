<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-API Chat Interface (v1.3)</title>

    <!-- External Dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/showdown@2.1.0/dist/showdown.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">

    <!-- Embedded CSS -->
    <style>
:root {

  /* Primitive Color Tokens */

  --color-white: rgba(255, 255, 255, 1);

  --color-black: rgba(0, 0, 0, 1);

  --color-cream-50: rgba(252, 252, 249, 1);

  --color-cream-100: rgba(255, 255, 253, 1);

  --color-gray-200: rgba(245, 245, 245, 1);

  --color-gray-300: rgba(167, 169, 169, 1);

  --color-gray-400: rgba(119, 124, 124, 1);

  --color-slate-500: rgba(98, 108, 113, 1);

  --color-brown-600: rgba(94, 82, 64, 1);

  --color-charcoal-700: rgba(31, 33, 33, 1);

  --color-charcoal-800: rgba(38, 40, 40, 1);

  --color-slate-900: rgba(19, 52, 59, 1);

  --color-teal-300: rgba(50, 184, 198, 1);

  --color-teal-400: rgba(45, 166, 178, 1);

  --color-teal-500: rgba(33, 128, 141, 1);

  --color-teal-600: rgba(29, 116, 128, 1);

  --color-teal-700: rgba(26, 104, 115, 1);

  --color-teal-800: rgba(41, 150, 161, 1);

  --color-red-400: rgba(255, 84, 89, 1);

  --color-red-500: rgba(192, 21, 47, 1);

  --color-orange-400: rgba(230, 129, 97, 1);

  --color-orange-500: rgba(168, 75, 47, 1);

  /* RGB versions for opacity control */

  --color-brown-600-rgb: 94, 82, 64;

  --color-teal-500-rgb: 33, 128, 141;

  --color-slate-900-rgb: 19, 52, 59;

  --color-slate-500-rgb: 98, 108, 113;

  --color-red-500-rgb: 192, 21, 47;

  --color-red-400-rgb: 255, 84, 89;

  --color-orange-500-rgb: 168, 75, 47;

  --color-orange-400-rgb: 230, 129, 97;

  /* Background color tokens (Light Mode) */

  --color-bg-1: rgba(59, 130, 246, 0.08); /* Light blue */

  --color-bg-2: rgba(245, 158, 11, 0.08); /* Light yellow */

  --color-bg-3: rgba(34, 197, 94, 0.08); /* Light green */

  --color-bg-4: rgba(239, 68, 68, 0.08); /* Light red */

  --color-bg-5: rgba(147, 51, 234, 0.08); /* Light purple */

  --color-bg-6: rgba(249, 115, 22, 0.08); /* Light orange */

  --color-bg-7: rgba(236, 72, 153, 0.08); /* Light pink */

  --color-bg-8: rgba(6, 182, 212, 0.08); /* Light cyan */

  /* Semantic Color Tokens (Light Mode) */

  --color-background: var(--color-cream-50);

  --color-surface: var(--color-cream-100);

  --color-text: var(--color-slate-900);

  --color-text-secondary: var(--color-slate-500);

  --color-primary: var(--color-teal-500);

  --color-primary-hover: var(--color-teal-600);

  --color-primary-active: var(--color-teal-700);

  --color-secondary: rgba(var(--color-brown-600-rgb), 0.12);

  --color-secondary-hover: rgba(var(--color-brown-600-rgb), 0.2);

  --color-secondary-active: rgba(var(--color-brown-600-rgb), 0.25);

  --color-border: rgba(var(--color-brown-600-rgb), 0.2);

  --color-btn-primary-text: var(--color-cream-50);

  --color-card-border: rgba(var(--color-brown-600-rgb), 0.12);

  --color-card-border-inner: rgba(var(--color-brown-600-rgb), 0.12);

  --color-error: var(--color-red-500);

  --color-success: var(--color-teal-500);

  --color-warning: var(--color-orange-500);

  --color-info: var(--color-slate-500);

  --color-focus-ring: rgba(var(--color-teal-500-rgb), 0.4);

  --color-select-caret: rgba(var(--color-slate-900-rgb), 0.8);

  /* Common style patterns */

  --focus-ring: 0 0 0 3px var(--color-focus-ring);

  --focus-outline: 2px solid var(--color-primary);

  --status-bg-opacity: 0.15;

  --status-border-opacity: 0.25;

  --select-caret-light: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23134252' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");

  --select-caret-dark: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23f5f5f5' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");

  /* RGB versions for opacity control */

  --color-success-rgb: 33, 128, 141;

  --color-error-rgb: 192, 21, 47;

  --color-warning-rgb: 168, 75, 47;

  --color-info-rgb: 98, 108, 113;

  /* Typography */

  --font-family-base: "FKGroteskNeue", "Geist", "Inter", -apple-system,

    BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;

  --font-family-mono: "Berkeley Mono", ui-monospace, SFMono-Regular, Menlo,

    Monaco, Consolas, monospace;

  --font-size-xs: 11px;

  --font-size-sm: 12px;

  --font-size-base: 14px;

  --font-size-md: 14px;

  --font-size-lg: 16px;

  --font-size-xl: 18px;

  --font-size-2xl: 20px;

  --font-size-3xl: 24px;

  --font-size-4xl: 30px;

  --font-weight-normal: 400;

  --font-weight-medium: 500;

  --font-weight-semibold: 550;

  --font-weight-bold: 600;

  --line-height-tight: 1.2;

  --line-height-normal: 1.5;

  --letter-spacing-tight: -0.01em;

  /* Spacing */

  --space-0: 0;

  --space-1: 1px;

  --space-2: 2px;

  --space-4: 4px;

  --space-6: 6px;

  --space-8: 8px;

  --space-10: 10px;

  --space-12: 12px;

  --space-16: 16px;

  --space-20: 20px;

  --space-24: 24px;

  --space-32: 32px;

  /* Border Radius */

  --radius-sm: 6px;

  --radius-base: 8px;

  --radius-md: 10px;

  --radius-lg: 12px;

  --radius-full: 9999px;

  /* Shadows */

  --shadow-xs: 0 1px 2px rgba(0, 0, 0, 0.02);

  --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.04), 0 1px 2px rgba(0, 0, 0, 0.02);

  --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.04),

    0 2px 4px -1px rgba(0, 0, 0, 0.02);

  --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.04),

    0 4px 6px -2px rgba(0, 0, 0, 0.02);

  --shadow-inset-sm: inset 0 1px 0 rgba(255, 255, 255, 0.15),

    inset 0 -1px 0 rgba(0, 0, 0, 0.03);

  /* Animation */

  --duration-fast: 150ms;

  --duration-normal: 250ms;

  --ease-standard: cubic-bezier(0.16, 1, 0.3, 1);

  /* Layout */

  --container-sm: 640px;

  --container-md: 768px;

  --container-lg: 1024px;

  --container-xl: 1280px;

}

/* Dark mode colors */

@media (prefers-color-scheme: dark) {

  :root {

    /* RGB versions for opacity control (Dark Mode) */

    --color-gray-400-rgb: 119, 124, 124;

    --color-teal-300-rgb: 50, 184, 198;

    --color-gray-300-rgb: 167, 169, 169;

    --color-gray-200-rgb: 245, 245, 245;

    /* Background color tokens (Dark Mode) */

    --color-bg-1: rgba(29, 78, 216, 0.15); /* Dark blue */

    --color-bg-2: rgba(180, 83, 9, 0.15); /* Dark yellow */

    --color-bg-3: rgba(21, 128, 61, 0.15); /* Dark green */

    --color-bg-4: rgba(185, 28, 28, 0.15); /* Dark red */

    --color-bg-5: rgba(107, 33, 168, 0.15); /* Dark purple */

    --color-bg-6: rgba(194, 65, 12, 0.15); /* Dark orange */

    --color-bg-7: rgba(190, 24, 93, 0.15); /* Dark pink */

    --color-bg-8: rgba(8, 145, 178, 0.15); /* Dark cyan */

    

    /* Semantic Color Tokens (Dark Mode) */

    --color-background: var(--color-charcoal-700);

    --color-surface: var(--color-charcoal-800);

    --color-text: var(--color-gray-200);

    --color-text-secondary: rgba(var(--color-gray-300-rgb), 0.7);

    --color-primary: var(--color-teal-300);

    --color-primary-hover: var(--color-teal-400);

    --color-primary-active: var(--color-teal-800);

    --color-secondary: rgba(var(--color-gray-400-rgb), 0.15);

    --color-secondary-hover: rgba(var(--color-gray-400-rgb), 0.25);

    --color-secondary-active: rgba(var(--color-gray-400-rgb), 0.3);

    --color-border: rgba(var(--color-gray-400-rgb), 0.3);

    --color-error: var(--color-red-400);

    --color-success: var(--color-teal-300);

    --color-warning: var(--color-orange-400);

    --color-info: var(--color-gray-300);

    --color-focus-ring: rgba(var(--color-teal-300-rgb), 0.4);

    --color-btn-primary-text: var(--color-slate-900);

    --color-card-border: rgba(var(--color-gray-400-rgb), 0.2);

    --color-card-border-inner: rgba(var(--color-gray-400-rgb), 0.15);

    --shadow-inset-sm: inset 0 1px 0 rgba(255, 255, 255, 0.1),

      inset 0 -1px 0 rgba(0, 0, 0, 0.15);

    --button-border-secondary: rgba(var(--color-gray-400-rgb), 0.2);

    --color-border-secondary: rgba(var(--color-gray-400-rgb), 0.2);

    --color-select-caret: rgba(var(--color-gray-200-rgb), 0.8);

    /* Common style patterns - updated for dark mode */

    --focus-ring: 0 0 0 3px var(--color-focus-ring);

    --focus-outline: 2px solid var(--color-primary);

    --status-bg-opacity: 0.15;

    --status-border-opacity: 0.25;

    --select-caret-light: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23134252' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");

    --select-caret-dark: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23f5f5f5' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");

    /* RGB versions for dark mode */

    --color-success-rgb: var(--color-teal-300-rgb);

    --color-error-rgb: var(--color-red-400-rgb);

    --color-warning-rgb: var(--color-orange-400-rgb);

    --color-info-rgb: var(--color-gray-300-rgb);

  }

}

/* Data attribute for manual theme switching */

[data-color-scheme="dark"] {

  /* RGB versions for opacity control (dark mode) */

  --color-gray-400-rgb: 119, 124, 124;

  --color-teal-300-rgb: 50, 184, 198;

  --color-gray-300-rgb: 167, 169, 169;

  --color-gray-200-rgb: 245, 245, 245;

  /* Colorful background palette - Dark Mode */

  --color-bg-1: rgba(29, 78, 216, 0.15); /* Dark blue */

  --color-bg-2: rgba(180, 83, 9, 0.15); /* Dark yellow */

  --color-bg-3: rgba(21, 128, 61, 0.15); /* Dark green */

  --color-bg-4: rgba(185, 28, 28, 0.15); /* Dark red */

  --color-bg-5: rgba(107, 33, 168, 0.15); /* Dark purple */

  --color-bg-6: rgba(194, 65, 12, 0.15); /* Dark orange */

  --color-bg-7: rgba(190, 24, 93, 0.15); /* Dark pink */

  --color-bg-8: rgba(8, 145, 178, 0.15); /* Dark cyan */

  

  /* Semantic Color Tokens (Dark Mode) */

  --color-background: var(--color-charcoal-700);

  --color-surface: var(--color-charcoal-800);

  --color-text: var(--color-gray-200);

  --color-text-secondary: rgba(var(--color-gray-300-rgb), 0.7);

  --color-primary: var(--color-teal-300);

  --color-primary-hover: var(--color-teal-400);

  --color-primary-active: var(--color-teal-800);

  --color-secondary: rgba(var(--color-gray-400-rgb), 0.15);

  --color-secondary-hover: rgba(var(--color-gray-400-rgb), 0.25);

  --color-secondary-active: rgba(var(--color-gray-400-rgb), 0.3);

  --color-border: rgba(var(--color-gray-400-rgb), 0.3);

  --color-error: var(--color-red-400);

  --color-success: var(--color-teal-300);

  --color-warning: var(--color-orange-400);

  --color-info: var(--color-gray-300);

  --color-focus-ring: rgba(var(--color-teal-300-rgb), 0.4);

  --color-btn-primary-text: var(--color-slate-900);

  --color-card-border: rgba(var(--color-gray-400-rgb), 0.15);

  --color-card-border-inner: rgba(var(--color-gray-400-rgb), 0.15);

  --shadow-inset-sm: inset 0 1px 0 rgba(255, 255, 255, 0.1),

    inset 0 -1px 0 rgba(0, 0, 0, 0.15);

  --color-border-secondary: rgba(var(--color-gray-400-rgb), 0.2);

  --color-select-caret: rgba(var(--color-gray-200-rgb), 0.8);

  /* Common style patterns - updated for dark mode */

  --focus-ring: 0 0 0 3px var(--color-focus-ring);

  --focus-outline: 2px solid var(--color-primary);

  --status-bg-opacity: 0.15;

  --status-border-opacity: 0.25;

  --select-caret-light: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23134252' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");

  --select-caret-dark: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23f5f5f5' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");

  /* RGB versions for dark mode */

  --color-success-rgb: var(--color-teal-300-rgb);

  --color-error-rgb: var(--color-red-400-rgb);

  --color-warning-rgb: var(--color-orange-400-rgb);

  --color-info-rgb: var(--color-gray-300-rgb);

}

[data-color-scheme="light"] {

  /* RGB versions for opacity control (light mode) */

  --color-brown-600-rgb: 94, 82, 64;

  --color-teal-500-rgb: 33, 128, 141;

  --color-slate-900-rgb: 19, 52, 59;

  

  /* Semantic Color Tokens (Light Mode) */

  --color-background: var(--color-cream-50);

  --color-surface: var(--color-cream-100);

  --color-text: var(--color-slate-900);

  --color-text-secondary: var(--color-slate-500);

  --color-primary: var(--color-teal-500);

  --color-primary-hover: var(--color-teal-600);

  --color-primary-active: var(--color-teal-700);

  --color-secondary: rgba(var(--color-brown-600-rgb), 0.12);

  --color-secondary-hover: rgba(var(--color-brown-600-rgb), 0.2);

  --color-secondary-active: rgba(var(--color-brown-600-rgb), 0.25);

  --color-border: rgba(var(--color-brown-600-rgb), 0.2);

  --color-btn-primary-text: var(--color-cream-50);

  --color-card-border: rgba(var(--color-brown-600-rgb), 0.12);

  --color-card-border-inner: rgba(var(--color-brown-600-rgb), 0.12);

  --color-error: var(--color-red-500);

  --color-success: var(--color-teal-500);

  --color-warning: var(--color-orange-500);

  --color-info: var(--color-slate-500);

  --color-focus-ring: rgba(var(--color-teal-500-rgb), 0.4);

  /* RGB versions for light mode */

  --color-success-rgb: var(--color-teal-500-rgb);

  --color-error-rgb: var(--color-red-500-rgb);

  --color-warning-rgb: var(--color-orange-500-rgb);

  --color-info-rgb: var(--color-slate-500-rgb);

}

/* Base styles */

html {

  font-size: var(--font-size-base);

  font-family: var(--font-family-base);

  line-height: var(--line-height-normal);

  color: var(--color-text);

  background-color: var(--color-background);

  -webkit-font-smoothing: antialiased;

  box-sizing: border-box;

}

body {

  margin: 0;

  padding: 0;

}

*,

*::before,

*::after {

  box-sizing: inherit;

}

/* Typography */

h1,

h2,

h3,

h4,

h5,

h6 {

  margin: 0;

  font-weight: var(--font-weight-semibold);

  line-height: var(--line-height-tight);

  color: var(--color-text);

  letter-spacing: var(--letter-spacing-tight);

}

h1 {

  font-size: var(--font-size-4xl);

}

h2 {

  font-size: var(--font-size-3xl);

}

h3 {

  font-size: var(--font-size-2xl);

}

h4 {

  font-size: var(--font-size-xl);

}

h5 {

  font-size: var(--font-size-lg);

}

h6 {

  font-size: var(--font-size-md);

}

p {

  margin: 0 0 var(--space-16) 0;

}

a {

  color: var(--color-primary);

  text-decoration: none;

  transition: color var(--duration-fast) var(--ease-standard);

}

a:hover {

  color: var(--color-primary-hover);

}

code,

pre {

  font-family: var(--font-family-mono);

  font-size: calc(var(--font-size-base) * 0.95);

  background-color: var(--color-secondary);

  border-radius: var(--radius-sm);

}

code {

  padding: var(--space-1) var(--space-4);

}

pre {

  padding: var(--space-16);

  margin: var(--space-16) 0;

  overflow: auto;

  border: 1px solid var(--color-border);

}

pre code {

  background: none;

  padding: 0;

}

/* Buttons */

.btn {

  display: inline-flex;

  align-items: center;

  justify-content: center;

  padding: var(--space-8) var(--space-16);

  border-radius: var(--radius-base);

  font-size: var(--font-size-base);

  font-weight: 500;

  line-height: 1.5;

  cursor: pointer;

  transition: all var(--duration-normal) var(--ease-standard);

  border: none;

  text-decoration: none;

  position: relative;

}

.btn:focus-visible {

  outline: none;

  box-shadow: var(--focus-ring);

}

.btn--primary {

  background: var(--color-primary);

  color: var(--color-btn-primary-text);

}

.btn--primary:hover {

  background: var(--color-primary-hover);

}

.btn--primary:active {

  background: var(--color-primary-active);

}

.btn--secondary {

  background: var(--color-secondary);

  color: var(--color-text);

}

.btn--secondary:hover {

  background: var(--color-secondary-hover);

}

.btn--secondary:active {

  background: var(--color-secondary-active);

}

.btn--outline {

  background: transparent;

  border: 1px solid var(--color-border);

  color: var(--color-text);

}

.btn--outline:hover {

  background: var(--color-secondary);

}

.btn--sm {

  padding: var(--space-4) var(--space-12);

  font-size: var(--font-size-sm);

  border-radius: var(--radius-sm);

}

.btn--lg {

  padding: var(--space-10) var(--space-20);

  font-size: var(--font-size-lg);

  border-radius: var(--radius-md);

}

.btn--full-width {

  width: 100%;

}

.btn:disabled {

  opacity: 0.5;

  cursor: not-allowed;

}

/* Form elements */

.form-control {

  display: block;

  width: 100%;

  padding: var(--space-8) var(--space-12);

  font-size: var(--font-size-md);

  line-height: 1.5;

  color: var(--color-text);

  background-color: var(--color-surface);

  border: 1px solid var(--color-border);

  border-radius: var(--radius-base);

  transition: border-color var(--duration-fast) var(--ease-standard),

    box-shadow var(--duration-fast) var(--ease-standard);

}

textarea.form-control {

  font-family: var(--font-family-base);

  font-size: var(--font-size-base);

}

select.form-control {

  padding: var(--space-8) var(--space-12);

  -webkit-appearance: none;

  -moz-appearance: none;

  appearance: none;

  background-image: var(--select-caret-light);

  background-repeat: no-repeat;

  background-position: right var(--space-12) center;

  background-size: 16px;

  padding-right: var(--space-32);

}

/* Add a dark mode specific caret */

@media (prefers-color-scheme: dark) {

  select.form-control {

    background-image: var(--select-caret-dark);

  }

}

/* Also handle data-color-scheme */

[data-color-scheme="dark"] select.form-control {

  background-image: var(--select-caret-dark);

}

[data-color-scheme="light"] select.form-control {

  background-image: var(--select-caret-light);

}

.form-control:focus {

  border-color: var(--color-primary);

  outline: var(--focus-outline);

}

.form-label {

  display: block;

  margin-bottom: var(--space-8);

  font-weight: var(--font-weight-medium);

  font-size: var(--font-size-sm);

}

.form-group {

  margin-bottom: var(--space-16);

}

/* Card component */

.card {

  background-color: var(--color-surface);

  border-radius: var(--radius-lg);

  border: 1px solid var(--color-card-border);

  box-shadow: var(--shadow-sm);

  overflow: hidden;

  transition: box-shadow var(--duration-normal) var(--ease-standard);

}

.card:hover {

  box-shadow: var(--shadow-md);

}

.card__body {

  padding: var(--space-16);

}

.card__header,

.card__footer {

  padding: var(--space-16);

  border-bottom: 1px solid var(--color-card-border-inner);

}

/* Status indicators - simplified with CSS variables */

.status {

  display: inline-flex;

  align-items: center;

  padding: var(--space-6) var(--space-12);

  border-radius: var(--radius-full);

  font-weight: var(--font-weight-medium);

  font-size: var(--font-size-sm);

}

.status--success {

  background-color: rgba(

    var(--color-success-rgb, 33, 128, 141),

    var(--status-bg-opacity)

  );

  color: var(--color-success);

  border: 1px solid

    rgba(var(--color-success-rgb, 33, 128, 141), var(--status-border-opacity));

}

.status--error {

  background-color: rgba(

    var(--color-error-rgb, 192, 21, 47),

    var(--status-bg-opacity)

  );

  color: var(--color-error);

  border: 1px solid

    rgba(var(--color-error-rgb, 192, 21, 47), var(--status-border-opacity));

}

.status--warning {

  background-color: rgba(

    var(--color-warning-rgb, 168, 75, 47),

    var(--status-bg-opacity)

  );

  color: var(--color-warning);

  border: 1px solid

    rgba(var(--color-warning-rgb, 168, 75, 47), var(--status-border-opacity));

}

.status--info {

  background-color: rgba(

    var(--color-info-rgb, 98, 108, 113),

    var(--status-bg-opacity)

  );

  color: var(--color-info);

  border: 1px solid

    rgba(var(--color-info-rgb, 98, 108, 113), var(--status-border-opacity));

}

/* Container layout */

.container {

  width: 100%;

  margin-right: auto;

  margin-left: auto;

  padding-right: var(--space-16);

  padding-left: var(--space-16);

}

@media (min-width: 640px) {

  .container {

    max-width: var(--container-sm);

  }

}

@media (min-width: 768px) {

  .container {

    max-width: var(--container-md);

  }

}

@media (min-width: 1024px) {

  .container {

    max-width: var(--container-lg);

  }

}

@media (min-width: 1280px) {

  .container {

    max-width: var(--container-xl);

  }

}

/* Utility classes */

.flex {

  display: flex;

}

.flex-col {

  flex-direction: column;

}

.items-center {

  align-items: center;

}

.justify-center {

  justify-content: center;

}

.justify-between {

  justify-content: space-between;

}

.gap-4 {

  gap: var(--space-4);

}

.gap-8 {

  gap: var(--space-8);

}

.gap-16 {

  gap: var(--space-16);

}

.m-0 {

  margin: 0;

}

.mt-8 {

  margin-top: var(--space-8);

}

.mb-8 {

  margin-bottom: var(--space-8);

}

.mx-8 {

  margin-left: var(--space-8);

  margin-right: var(--space-8);

}

.my-8 {

  margin-top: var(--space-8);

  margin-bottom: var(--space-8);

}

.p-0 {

  padding: 0;

}

.py-8 {

  padding-top: var(--space-8);

  padding-bottom: var(--space-8);

}

.px-8 {

  padding-left: var(--space-8);

  padding-right: var(--space-8);

}

.py-16 {

  padding-top: var(--space-16);

  padding-bottom: var(--space-16);

}

.px-16 {

  padding-left: var(--space-16);

  padding-right: var(--space-16);

}

.block {

  display: block;

}

.hidden {

  display: none;

}

/* Accessibility */

.sr-only {

  position: absolute;

  width: 1px;

  height: 1px;

  padding: 0;

  margin: -1px;

  overflow: hidden;

  clip: rect(0, 0, 0, 0);

  white-space: nowrap;

  border-width: 0;

}

:focus-visible {

  outline: var(--focus-outline);

  outline-offset: 2px;

}

/* Dark mode specifics */

[data-color-scheme="dark"] .btn--outline {

  border: 1px solid var(--color-border-secondary);

}

@font-face {

  font-family: 'FKGroteskNeue';

  src: url('https://r2cdn.perplexity.ai/fonts/FKGroteskNeue.woff2')

    format('woff2');

}

/* END PERPLEXITY DESIGN SYSTEM */

/* App Layout */

.app-container {

  display: flex;

  height: 100vh;

  background-color: var(--color-background);

}

/* Sidebar */

.sidebar {

  width: 50px;

  background-color: var(--color-surface);

  border-right: 1px solid var(--color-border);

  display: flex;

  flex-direction: column;

  align-items: center;

  padding: var(--space-8) 0;

  gap: var(--space-16);

  position: fixed;

  left: 0;

  top: 0;

  height: 100vh;

  z-index: 100;

  box-shadow: var(--shadow-sm);

}

.sidebar-icon {

  width: 36px;

  height: 36px;

  border-radius: var(--radius-base);

  background-color: var(--color-secondary);

  display: flex;

  align-items: center;

  justify-content: center;

  cursor: pointer;

  transition: all var(--duration-fast) var(--ease-standard);

  border: 1px solid var(--color-border);

}

.sidebar-icon:hover {

  background-color: var(--color-secondary-hover);

  transform: translateY(-1px);

  box-shadow: var(--shadow-sm);

}

.sidebar-icon:active {

  background-color: var(--color-secondary-active);

  transform: translateY(0);

}

.sidebar-icon.active {

  background-color: var(--color-primary);

  color: var(--color-btn-primary-text);

}

.sidebar-icon .icon {

  font-size: var(--font-size-lg);

}

/* Main Content */

.main-content {

  margin-left: 50px;

  flex: 1;

  display: flex;

  flex-direction: column;

  max-width: 200px;

  width: 100%;

  background-color: var(--color-background);

}

/* Enhanced Header */

.header {

  background: linear-gradient(135deg, var(--color-bg-1), var(--color-bg-8));

  border-bottom: 1px solid var(--color-border);

  padding: var(--space-12) var(--space-16);

  display: flex;

  justify-content: space-between;

  align-items: center;

  transition: all var(--duration-normal) var(--ease-standard);

  overflow: hidden;

  position: relative;

  z-index: 50;

}

.header.collapsed {

  padding: var(--space-4) var(--space-16);

}

.header.collapsed .header-info h1 {

  font-size: var(--font-size-sm);

  opacity: 0.8;

}

.header.collapsed .status-line {

  font-size: var(--font-size-xs);

  opacity: 0.7;

}

.header-info {

  display: flex;

  flex-direction: column;

  gap: var(--space-4);

}

.header-info h1 {

  margin: 0;

  font-size: var(--font-size-lg);

  font-weight: var(--font-weight-bold);

  color: var(--color-text);

  transition: all var(--duration-normal) var(--ease-standard);

}

.status-line {

  display: flex;

  align-items: center;

  gap: var(--space-8);

  font-size: var(--font-size-sm);

  color: var(--color-text-secondary);

  transition: all var(--duration-normal) var(--ease-standard);

}

.status-item {

  font-weight: var(--font-weight-medium);

}

.status-divider {

  color: var(--color-border);

}

.collapse-btn {

  background: var(--color-secondary);

  border: 1px solid var(--color-border);

  border-radius: var(--radius-sm);

  width: 24px;

  height: 24px;

  display: flex;

  align-items: center;

  justify-content: center;

  cursor: pointer;

  font-size: var(--font-size-sm);

  color: var(--color-text);

  transition: all var(--duration-fast) var(--ease-standard);

}

.collapse-btn:hover {

  background-color: var(--color-secondary-hover);

}

/* Chat Container */

.chat-container {

  flex: 1;

  overflow-y: auto;

  padding: var(--space-16) var(--space-12);

  background-color: var(--color-background);

}

.messages {

  display: flex;

  flex-direction: column;

  gap: var(--space-16);

  min-height: 100%;

}

.message {

  background-color: var(--color-surface);

  border-radius: var(--radius-lg);

  padding: var(--space-12);

  border: 1px solid var(--color-card-border);

  box-shadow: var(--shadow-xs);

  word-wrap: break-word;

  overflow-wrap: break-word;

}

.message.user {

  background-color: var(--color-bg-1);

  border-color: var(--color-primary);

  margin-left: var(--space-8);

}

.message.assistant {

  background-color: var(--color-surface);

  margin-right: var(--space-8);

}

.message-header {

  display: flex;

  justify-content: space-between;

  align-items: center;

  margin-bottom: var(--space-8);

  font-size: var(--font-size-xs);

  color: var(--color-text-secondary);

}

.message-role {

  font-weight: var(--font-weight-medium);

  text-transform: uppercase;

  letter-spacing: 0.5px;

}

.copy-btn {

  background: none;

  border: none;

  cursor: pointer;

  padding: var(--space-2);

  border-radius: var(--radius-sm);

  color: var(--color-text-secondary);

  transition: all var(--duration-fast) var(--ease-standard);

}

.copy-btn:hover {

  background-color: var(--color-secondary);

  color: var(--color-text);

}

.message-content {

  font-size: var(--font-size-sm);

  line-height: var(--line-height-normal);

  color: var(--color-text);

}

/* Enhanced Code Block Styling */

.message-content pre {

  background-color: var(--color-secondary);

  padding: var(--space-12);

  border-radius: var(--radius-base);

  overflow-x: auto;

  font-size: var(--font-size-xs);

  position: relative;

  border: 1px solid var(--color-border);

}

.message-content pre code {

  background: none;

  padding: 0;

  border-radius: 0;

  font-family: var(--font-family-mono);

  line-height: 1.4;

}

.code-block {

  position: relative;

  margin: var(--space-8) 0;

}

.code-header {

  display: flex;

  justify-content: space-between;

  align-items: center;

  background-color: var(--color-secondary);

  padding: var(--space-6) var(--space-12);

  border-top-left-radius: var(--radius-base);

  border-top-right-radius: var(--radius-base);

  border: 1px solid var(--color-border);

  border-bottom: none;

  font-size: var(--font-size-xs);

  color: var(--color-text-secondary);

}

.code-language {

  font-weight: var(--font-weight-medium);

  text-transform: uppercase;

}

.code-copy-btn {

  background: var(--color-background);

  border: 1px solid var(--color-border);

  border-radius: var(--radius-sm);

  padding: var(--space-2) var(--space-6);

  font-size: var(--font-size-xs);

  cursor: pointer;

  transition: all var(--duration-fast) var(--ease-standard);

  color: var(--color-text);

}

.code-copy-btn:hover {

  background-color: var(--color-secondary);

}

.code-block pre {

  margin: 0;

  border-top-left-radius: 0;

  border-top-right-radius: 0;

  border-top: none;

}

/* Line numbers for code blocks */

.code-with-lines {

  position: relative;

}

.code-with-lines pre {

  padding-left: var(--space-32);

}

.line-numbers {

  position: absolute;

  left: 0;

  top: var(--space-12);

  bottom: var(--space-12);

  width: var(--space-24);

  padding: 0 var(--space-4);

  background-color: rgba(var(--color-text-secondary), 0.1);

  border-right: 1px solid var(--color-border);

  font-family: var(--font-family-mono);

  font-size: var(--font-size-xs);

  line-height: 1.4;

  color: var(--color-text-secondary);

  text-align: right;

  user-select: none;

  overflow: hidden;

}

.message-content code {

  background-color: var(--color-secondary);

  padding: var(--space-1) var(--space-4);

  border-radius: var(--radius-sm);

  font-size: var(--font-size-xs);

  font-family: var(--font-family-mono);

}

.message-content blockquote {

  border-left: 3px solid var(--color-primary);

  padding-left: var(--space-12);

  margin: var(--space-8) 0;

  color: var(--color-text-secondary);

  font-style: italic;

}

/* Clickable References */

.reference-link {

  color: var(--color-primary);

  cursor: pointer;

  text-decoration: none;

  font-weight: var(--font-weight-medium);

  padding: var(--space-1) var(--space-2);

  border-radius: var(--radius-sm);

  transition: all var(--duration-fast) var(--ease-standard);

}

.reference-link:hover {

  background-color: var(--color-secondary);

  color: var(--color-primary-hover);

}

.message-image {

  max-width: 100%;

  height: auto;

  border-radius: var(--radius-base);

  margin: var(--space-8) 0;

  border: 1px solid var(--color-border);

}

/* Input Area */

.input-area {

  border-top: 1px solid var(--color-border);

  background-color: var(--color-surface);

  padding: var(--space-12);

}

.input-wrapper {

  display: flex;

  align-items: flex-end;

  gap: var(--space-8);

  background-color: var(--color-background);

  border: 1px solid var(--color-border);

  border-radius: var(--radius-lg);

  padding: var(--space-8);

  transition: border-color var(--duration-fast) var(--ease-standard);

}

.input-wrapper:focus-within {

  border-color: var(--color-primary);

}

#messageInput {

  flex: 1;

  border: none;

  outline: none;

  resize: none;

  background: transparent;

  font-family: var(--font-family-base);

  font-size: var(--font-size-sm);

  line-height: var(--line-height-normal);

  color: var(--color-text);

  min-height: 20px;

  max-height: 120px;

  overflow-y: auto;

}

#messageInput::placeholder {

  color: var(--color-text-secondary);

}

.input-actions {

  display: flex;

  gap: var(--space-4);

  align-items: center;

}

.action-btn {

  width: 28px;

  height: 28px;

  border: none;

  background-color: var(--color-secondary);

  border-radius: var(--radius-sm);

  cursor: pointer;

  display: flex;

  align-items: center;

  justify-content: center;

  transition: all var(--duration-fast) var(--ease-standard);

  font-size: var(--font-size-sm);

  color: var(--color-text);

}

.action-btn:hover {

  background-color: var(--color-secondary-hover);

  transform: translateY(-1px);

}

.send-btn {

  width: 32px;

  height: 32px;

  border: none;

  background-color: var(--color-primary);

  border-radius: var(--radius-base);

  cursor: pointer;

  display: flex;

  align-items: center;

  justify-content: center;

  color: var(--color-btn-primary-text);

  transition: all var(--duration-fast) var(--ease-standard);

  font-size: var(--font-size-base);

}

.send-btn:hover:not(:disabled) {

  background-color: var(--color-primary-hover);

  transform: translateY(-1px);

}

.send-btn:disabled {

  background-color: var(--color-secondary);

  cursor: not-allowed;

  transform: none;

  opacity: 0.6;

}

/* Token Display */

.token-display {

  margin-top: var(--space-8);

  padding: var(--space-6) var(--space-8);

  background-color: var(--color-secondary);

  border-radius: var(--radius-sm);

  font-size: var(--font-size-xs);

  color: var(--color-text-secondary);

}

.token-display.hidden {

  display: none;

}

.token-info {

  display: flex;

  align-items: center;

  gap: var(--space-12);

}

.token-count {

  font-weight: var(--font-weight-medium);

}

.token-details {

  opacity: 0.8;

}

/* Popups */

.popup {

  position: fixed;

  top: 0;

  left: 0;

  width: 100vw;

  height: 100vh;

  background-color: rgba(0, 0, 0, 0.5);

  display: flex;

  align-items: center;

  justify-content: center;

  z-index: 1000;

  transition: opacity var(--duration-normal) var(--ease-standard);

}

.popup.hidden {

  display: none;

}

.popup-content {

  background-color: var(--color-surface);

  border-radius: var(--radius-lg);

  padding: var(--space-20);

  min-width: 200px;

  max-width: 400px;

  max-height: 80vh;

  overflow-y: auto;

  border: 1px solid var(--color-border);

  box-shadow: var(--shadow-lg);

  animation: popupSlide var(--duration-normal) var(--ease-standard);

}

/* Reference Popup Specific Styling */

.reference-popup-content {

  min-width: 300px;

  max-width: 500px;

}

.reference-header {

  display: flex;

  justify-content: space-between;

  align-items: center;

  margin-bottom: var(--space-12);

  padding-bottom: var(--space-8);

  border-bottom: 1px solid var(--color-border);

}

.reference-header h3 {

  margin: 0;

  font-size: var(--font-size-lg);

  color: var(--color-text);

}

.close-btn {

  background: none;

  border: none;

  font-size: var(--font-size-xl);

  cursor: pointer;

  color: var(--color-text-secondary);

  padding: var(--space-2);

  border-radius: var(--radius-sm);

  transition: all var(--duration-fast) var(--ease-standard);

  line-height: 1;

}

.close-btn:hover {

  background-color: var(--color-secondary);

  color: var(--color-text);

}

.reference-body {

  margin-bottom: var(--space-16);

}

.reference-body p {

  margin: 0 0 var(--space-12) 0;

  word-break: break-all;

  font-size: var(--font-size-sm);

  color: var(--color-text);

}

.reference-actions {

  display: flex;

  gap: var(--space-8);

}

@keyframes popupSlide {

  from {

    transform: translateY(-10px);

    opacity: 0;

  }

  to {

    transform: translateY(0);

    opacity: 1;

  }

}

.popup-content h3 {

  margin: 0 0 var(--space-16) 0;

  font-size: var(--font-size-lg);

  color: var(--color-text);

}

.popup-content h4 {

  margin: var(--space-16) 0 var(--space-8) 0;

  font-size: var(--font-size-md);

  color: var(--color-text);

  font-weight: var(--font-weight-medium);

}

.popup-content h4:first-of-type {

  margin-top: 0;

}

.api-section {

  margin-bottom: var(--space-16);

}

.api-section:last-child {

  margin-bottom: 0;

}

.theme-options,

.persona-options,

.model-options {

  display: flex;

  flex-direction: column;

  gap: var(--space-8);

}

.theme-option,

.persona-option,

.model-option {

  padding: var(--space-8) var(--space-12);

  border: 1px solid var(--color-border);

  background-color: var(--color-secondary);

  border-radius: var(--radius-base);

  cursor: pointer;

  transition: all var(--duration-fast) var(--ease-standard);

  text-align: left;

  font-size: var(--font-size-sm);

  color: var(--color-text);

  display: flex;

  align-items: center;

  gap: var(--space-8);

}

.theme-option:hover,

.persona-option:hover,

.model-option:hover {

  background-color: var(--color-secondary-hover);

  transform: translateY(-1px);

}

.theme-option.active,

.persona-option.active,

.model-option.active {

  background-color: var(--color-primary);

  color: var(--color-btn-primary-text);

  border-color: var(--color-primary);

}

.custom-prompt-section {

  margin-top: var(--space-16);

}

.custom-prompt-section.hidden {

  display: none;

}

.custom-prompt-section textarea {

  width: 100%;

  min-height: 80px;

  padding: var(--space-8);

  border: 1px solid var(--color-border);

  border-radius: var(--radius-base);

  background-color: var(--color-background);

  color: var(--color-text);

  font-family: var(--font-family-base);

  font-size: var(--font-size-sm);

  resize: vertical;

  margin-bottom: var(--space-8);

  box-sizing: border-box;

}

.custom-prompt-section textarea::placeholder {

  color: var(--color-text-secondary);

}

/* Status indicators */

.status-container {

  position: fixed;

  top: var(--space-16);

  right: var(--space-16);

  z-index: 1001;

}

.status {

  transition: all var(--duration-normal) var(--ease-standard);

}

.status.show {

  display: inline-flex !important;

}

/* Loading animation */

.loading {

  display: inline-flex;

  align-items: center;

  gap: var(--space-8);

  color: var(--color-text-secondary);

  font-size: var(--font-size-sm);

}

.loading::after {

  content: "";

  width: 12px;

  height: 12px;

  border: 2px solid var(--color-border);

  border-top: 2px solid var(--color-primary);

  border-radius: 50%;

  animation: spin 1s linear infinite;

}

@keyframes spin {

  0% { transform: rotate(0deg); }

  100% { transform: rotate(360deg); }

}

/* Form elements in popups */

.form-group {

  margin-bottom: var(--space-12);

  display: flex;

  flex-direction: column;

  gap: var(--space-4);

}

.form-group:last-child {

  flex-direction: row;

  align-items: center;

  gap: var(--space-8);

}

.form-label {

  display: block;

  margin-bottom: var(--space-6);

  font-weight: var(--font-weight-medium);

  font-size: var(--font-size-sm);

  color: var(--color-text);

}

.form-control {

  width: 100%;

  padding: var(--space-8);

  border: 1px solid var(--color-border);

  border-radius: var(--radius-base);

  background-color: var(--color-background);

  color: var(--color-text);

  font-family: var(--font-family-base);

  font-size: var(--font-size-sm);

  box-sizing: border-box;

}

.form-control::placeholder {

  color: var(--color-text-secondary);

}

.form-control:focus {

  outline: none;

  border-color: var(--color-primary);

  box-shadow: var(--focus-ring);

}

/* Mobile responsiveness */

@media (max-width: 768px) {

  .sidebar {

    width: 45px;

  }

  

  .main-content {

    margin-left: 45px;

    max-width: none;

    width: calc(100vw - 45px);

  }

  

  .popup-content {

    margin: var(--space-16);

    min-width: auto;

    max-width: calc(100vw - var(--space-32));

  }

  

  .header-info h1 {

    font-size: var(--font-size-md);

  }

  

  .status-line {

    font-size: var(--font-size-xs);

  }

  

  .message {

    padding: var(--space-8);

    font-size: var(--font-size-xs);

  }

  

  .input-area {

    padding: var(--space-8);

  }

  

  .sidebar-icon {

    width: 32px;

    height: 32px;

  }

  

  .sidebar-icon .icon {

    font-size: var(--font-size-md);

  }

  

  .reference-popup-content {

    min-width: 250px;

    max-width: calc(100vw - var(--space-32));

  }

}

/* Token Usage Corner Display */

.token-usage-corner {

    position: absolute;

    top: var(--space-8);

    right: var(--space-12);

    font-size: var(--font-size-xs);

    color: var(--color-text-secondary);

    background-color: var(--color-secondary);

    padding: var(--space-2) var(--space-6);

    border-radius: var(--radius-sm);

    font-family: var(--font-family-mono);

    font-weight: var(--font-weight-medium);

    opacity: 0.8;

    transition: opacity var(--duration-fast) var(--ease-standard);

    border: 1px solid var(--color-border);

    box-shadow: var(--shadow-xs);

    cursor: help;

    z-index: 10;

}

.token-usage-corner:hover {

    opacity: 1;

    transform: translateY(-1px);

    box-shadow: var(--shadow-sm);

}

/* Ensure message has relative positioning for absolute token corner */

.message {

    position: relative;

}

/* One-shot Mode Button Active State */

.sidebar-icon.active {

    background-color: var(--color-primary);

    color: var(--color-btn-primary-text);

    box-shadow: var(--shadow-md);

}

.sidebar-icon.active:hover {

    background-color: var(--color-primary-hover);

    transform: translateY(-1px);

    box-shadow: var(--shadow-lg);

}

.sidebar-icon.active .icon {

    filter: brightness(1.1);

}

/* Enhanced Message Layout for Token Corner */

.message.assistant {

    padding-top: var(--space-16); /* Extra space for token corner */

}

/* Mobile Responsive Updates for Token Corner */

@media (max-width: 768px) {

    .token-usage-corner {

        font-size: calc(var(--font-size-xs) - 1px);

        padding: var(--space-1) var(--space-4);

        right: var(--space-8);

        top: var(--space-6);

    }

    .message.assistant {

        padding-top: var(--space-12);

    }

}

/* Dark Mode Specific Adjustments for New Elements */

@media (prefers-color-scheme: dark) {

    .token-usage-corner {

        background-color: rgba(var(--color-gray-400-rgb), 0.15);

        border-color: rgba(var(--color-gray-400-rgb), 0.3);

        color: var(--color-gray-300);

    }

    .sidebar-icon.active {

        background-color: var(--color-teal-300);

        color: var(--color-slate-900);

    }

    .sidebar-icon.active:hover {

        background-color: var(--color-teal-400);

    }

}

[data-color-scheme="dark"] .token-usage-corner {

    background-color: rgba(var(--color-gray-400-rgb), 0.15);

    border-color: rgba(var(--color-gray-400-rgb), 0.3);

    color: var(--color-gray-300);

}

[data-color-scheme="dark"] .sidebar-icon.active {

    background-color: var(--color-teal-300);

    color: var(--color-slate-900);

}

[data-color-scheme="dark"] .sidebar-icon.active:hover {

    background-color: var(--color-teal-400);

}

/* Light Mode Specific for Active Button */

[data-color-scheme="light"] .sidebar-icon.active {

    background-color: var(--color-teal-500);

    color: var(--color-cream-50);

}

[data-color-scheme="light"] .sidebar-icon.active:hover {

    background-color: var(--color-teal-600);

}

/* Animation for One-shot Mode Button Activation */

.sidebar-icon.active {

    animation: activateButton var(--duration-normal) var(--ease-standard);

}

@keyframes activateButton {

    0% {

        transform: scale(1);

        box-shadow: var(--shadow-sm);

    }

    50% {

        transform: scale(1.1);

        box-shadow: var(--shadow-lg);

    }

    100% {

        transform: scale(1);

        box-shadow: var(--shadow-md);

    }

}

/* Improved Sidebar Icon Tooltips */

.sidebar-icon {

    position: relative;

}

.sidebar-icon::after {

    content: attr(title);

    position: absolute;

    left: 100%;

    top: 50%;

    transform: translateY(-50%);

    margin-left: var(--space-8);

    background-color: var(--color-surface);

    color: var(--color-text);

    padding: var(--space-4) var(--space-8);

    border-radius: var(--radius-sm);

    font-size: var(--font-size-xs);

    white-space: nowrap;

    opacity: 0;

    pointer-events: none;

    transition: opacity var(--duration-normal) var(--ease-standard);

    z-index: 1000;

    border: 1px solid var(--color-border);

    box-shadow: var(--shadow-md);

    max-width: 200px;

    word-wrap: break-word;

    white-space: normal;

}

.sidebar-icon:hover::after {

    opacity: 1;

}

/* Hide tooltips on mobile */

@media (max-width: 768px) {

    .sidebar-icon::after {

        display: none;

    }

}

/* Enhanced Focus States for Accessibility */

.sidebar-icon:focus-visible {

    outline: var(--focus-outline);

    outline-offset: 2px;

}

/* Token Corner Responsive Text */

@media (max-width: 480px) {

    .token-usage-corner {

        font-size: 9px;

        padding: 1px var(--space-2);

        right: var(--space-4);

        top: var(--space-4);

    }

}

/* Smooth Transition for Message Changes */

.message {

    transition: padding var(--duration-fast) var(--ease-standard);

}

/* Ensure proper stacking of token corner */

.message-content {

    position: relative;

    z-index: 1;

}

.token-usage-corner {

    z-index: 2;

}
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-icon" id="themeToggle" title="Theme">
                <span class="icon">☀️</span>
            </div>
            <div class="sidebar-icon" id="personaToggle" title="Persona">
                <span class="icon">👤</span>
            </div>
            <div class="sidebar-icon" id="oneShotToggle" title="One-shot Mode (Clear history on each new message)">
                <span class="icon">🔥</span>
            </div>
            <div class="sidebar-icon" id="clearHistory" title="Clear History">
                <span class="icon">🗑️</span>
            </div>
            <div class="sidebar-icon" id="apiKeyToggle" title="API Keys">
                <span class="icon">🔑</span>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Header -->
            <div class="header" id="header">
                <div class="header-info">
                    <h1>Multi-API Chat Interface</h1>
                    <div class="status-line">
                        <span class="status-item" id="modelStatus">Model: Sonar</span>
                        <span class="status-divider"> | </span>
                        <span class="status-item" id="personaStatus">Persona: All-rounder</span>
                    </div>
                </div>
                <button class="collapse-btn" id="collapseHeader">
                    <span>−</span>
                </button>
            </div>

            <!-- Chat Container -->
            <div class="chat-container" id="chatContainer">
                <div class="messages" id="messages">
                    <!-- Messages will be dynamically added here -->
                </div>
            </div>

            <!-- Input Area with Image Preview -->
            <div class="input-area">
                <!-- Image Preview Container (will be added dynamically) -->
                <div id="imagePreview" class="image-preview hidden"></div>
                <div class="input-wrapper">
                    <textarea 
                        id="messageInput" 
                        placeholder="Type your message here..."
                        rows="1"></textarea>
                    <div class="input-actions">
                        <button class="action-btn" id="imageUpload" title="Upload Image">
                            <span>📷</span>
                        </button>
                        <button class="action-btn" id="modelToggle" title="Change Model">
                            <span>⚙️</span>
                        </button>
                        <button class="send-btn" id="sendMessage" title="Send Message">
                            <span>→</span>
                        </button>
                    </div>
                </div>
                <div class="token-display hidden" id="tokenDisplay">
                    <div class="token-info">
                        <span class="token-count" id="tokenCount">Tokens: 0</span>
                        <span class="token-details" id="tokenDetails"></span>
                    </div>
                </div>
                <input type="file" id="fileInput" accept="image/*" style="display: none;">
            </div>
        </div>
    </div>

    <!-- Status Indicator -->
    <div class="status-container">
        <div class="status hidden" id="statusIndicator"></div>
    </div>

    <!-- Theme Popup -->
    <div class="popup hidden" id="themePopup">
        <div class="popup-content">
            <h3>Choose Theme</h3>
            <div class="theme-options">
                <button class="theme-option" data-theme="light">
                    <span>☀️</span> Light Theme
                </button>
                <button class="theme-option" data-theme="dark">
                    <span>🌙</span> Dark Theme  
                </button>
            </div>
        </div>
    </div>

    <!-- Persona Popup -->
    <div class="popup hidden" id="personaPopup">
        <div class="popup-content">
            <h3>Choose Persona</h3>
            <div class="persona-options">
                <button class="persona-option" data-persona="allrounder">
                    <span>🎯</span> All-rounder
                </button>
                <button class="persona-option" data-persona="grammar">
                    <span>📝</span> Grammar checker
                </button>
                <button class="persona-option" data-persona="auditor">
                    <span>🔍</span> Auditor
                </button>
                <button class="persona-option" data-persona="customized">
                    <span>⚙️</span> Customized
                </button>
            </div>
            <div class="custom-prompt-section hidden" id="customPromptSection">
                <label class="form-label">Custom Prompt:</label>
                <textarea id="customPrompt" placeholder="Enter your custom prompt here..." rows="3"></textarea>
                <button class="btn btn--primary btn--sm" id="saveCustomPrompt">Save Custom Prompt</button>
            </div>
        </div>
    </div>

    <!-- Model Popup -->
    <div class="popup hidden" id="modelPopup">
        <div class="popup-content">
            <h3>Choose Model</h3>
            <h4>Perplexity Models</h4>
            <div class="model-options">
                <button class="model-option" data-model="sonar" data-api="perplexity">
                    <span>🔍</span> Sonar
                </button>
                <button class="model-option" data-model="sonar-pro" data-api="perplexity">
                    <span>🔍</span> Sonar Pro
                </button>
                <button class="model-option" data-model="sonar-reasoning" data-api="perplexity">
                    <span>🧠</span> Sonar Reasoning
                </button>
                <button class="model-option" data-model="sonar-deep-research" data-api="perplexity">
                    <span>📚</span> Sonar Deep Research
                </button>
            </div>
            <h4>Moonshot Models</h4>
            <div class="model-options">
                <button class="model-option" data-model="moonshot-v1-8k" data-api="moonshot">
                    <span>🌙</span> K2-8K
                </button>
                <button class="model-option" data-model="moonshot-v1-32k" data-api="moonshot">
                    <span>🌙</span> K2-32K
                </button>
                <button class="model-option" data-model="moonshot-v1-128k" data-api="moonshot">
                    <span>🌙</span> K2-128K
                </button>
            </div>
        </div>
    </div>

    <!-- API Key Popup -->
    <div class="popup hidden" id="apiKeyPopup">
        <div class="popup-content">
            <h3>API Keys</h3>
            <div class="api-section">
                <h4>Perplexity API</h4>
                <div class="form-group">
                    <label class="form-label">API Key:</label>
                    <input type="password" id="perplexityApiKey" class="form-control" placeholder="Enter Perplexity API key">
                </div>
            </div>
            <div class="api-section">
                <h4>Moonshot API</h4>
                <div class="form-group">
                    <label class="form-label">API Key:</label>
                    <input type="password" id="moonshotApiKey" class="form-control" placeholder="Enter Moonshot API key">
                </div>
            </div>
            <div class="form-group">
                <button class="btn btn--secondary btn--sm" id="showApiKeys">Show/Hide</button>
                <button class="btn btn--primary btn--sm" id="saveApiKeys">Save Keys</button>
            </div>
        </div>
    </div>

    <!-- Reference Popup -->
    <div class="popup hidden" id="referencePopup">
        <div class="popup-content reference-popup-content">
            <div class="reference-header">
                <h3 id="referenceTitle">Reference</h3>
                <button class="close-btn" id="closeReferencePopup">&times;</button>
            </div>
            <div class="reference-body">
                <p id="referenceUrl"></p>
            </div>
            <div class="reference-actions">
                <button class="btn btn--secondary btn--sm" id="copyReference">Copy URL</button>
                <button class="btn btn--primary btn--sm" id="openReference">Open Link</button>
            </div>
        </div>
    </div>

    <!-- Embedded JavaScript -->
    <script>
class MultiAPIChat {

    constructor() {

        this.apiKeys = {

            perplexity: localStorage.getItem('perplexity_api_key') || '',

            moonshot: localStorage.getItem('moonshot_api_key') || ''

        };

        this.currentModel = 'sonar';

        this.currentAPI = 'perplexity';

        this.currentPersona = 'allrounder';

        this.customPrompt = '';

        this.messages = [];

        this.uploadedImage = null;

        this.isLoading = false;

        this.references = {};

        this.currentReference = { num: '', url: '' };

        // New feature: One-shot mode for clearing history on each new message

        this.oneShotMode = localStorage.getItem('oneShotMode') === 'true' || false;

        // Enhanced Showdown configuration

        this.converter = new showdown.Converter({

            tables: true,

            strikethrough: true,

            tasklists: true,

            ghCodeBlocks: true,

            ghMentions: false,

            ghMentionsLink: false,

            encodeEmails: false,

            openLinksInNewWindow: true,

            backslashEscapesHTMLTags: true,

            emoji: true,

            underline: true,

            completeHTMLDocument: false,

            metadata: false,

            splitAdjacentBlockquotes: true

        });

        this.personas = {

            allrounder: {

                name: "All-rounder",

                prompt: "You are a versatile AI assistant."

            },

            grammar: {

                name: "Grammar checker",

                prompt: "You are a professional grammar checker and language expert. Your specialties include:\n- Checking grammar errors in various languages\n- Providing clear correction suggestions\n- Explaining grammar rules and usage\n- Helping improve text expression and fluency\n- Offering synonyms and better phrasing options\n- Checking correct punctuation usage\n\nWhen checking grammar, please:\n1. Point out specific errors\n2. Provide the correct version\n3. Briefly explain why the correction is needed\n4. If multiple correct expressions exist, provide options\n\nPlease respond in English and explain in English, unless checking grammar for other language."

            },

            auditor: {

                name: "Auditor",

                prompt: "You are an experienced audit specialist with expertise in financial auditing, internal controls, and risk management. Your professional areas include:\n- Financial statement auditing and analysis\n- Internal control system assessment\n- Risk identification and management\n- Regulatory compliance checking\n- Audit procedures and methodology\n- Accounting standards and audit standards\n- Fraud detection and prevention\n\nWhen responding, please:\n1. Provide professional and accurate audit perspectives\n2. Reference relevant audit standards or regulations\n3. Suggest specific audit procedures or control measures\n4. Assess risk levels and impact severity\n5. Provide practical recommendations and best practices\n\nPlease respond in English and maintain professional audit terminology and standards."

            },

            customized: {

                name: "Customized",

                prompt: ""

            }

        };

        this.models = {

            perplexity: [

                { value: "sonar", name: "Sonar" },

                { value: "sonar-pro", name: "Sonar Pro" },

                { value: "sonar-reasoning", name: "Sonar Reasoning" },

                { value: "sonar-deep-research", name: "Sonar Deep Research" }

            ],

            moonshot: [

                { value: "moonshot-v1-8k", name: "K2-8K" },

                { value: "moonshot-v1-32k", name: "K2-32K" },

                { value: "moonshot-v1-128k", name: "K2-128K" }

            ]

        };

        this.apiEndpoints = {

            perplexity: "https://api.perplexity.ai/chat/completions",

            moonshot: "https://api.moonshot.cn/v1/chat/completions"

        };

        this.initializeElements();

        this.attachEventListeners();

        this.loadTheme();

        this.loadSettings();

        this.updateUI();

        this.updateHeaderStatus();

        this.updateOneShotButton(); // Update the new button state

    }

    initializeElements() {

        // Sidebar elements

        this.themeToggle = document.getElementById('themeToggle');

        this.personaToggle = document.getElementById('personaToggle');

        this.clearHistory = document.getElementById('clearHistory');

        this.apiKeyToggle = document.getElementById('apiKeyToggle');

        this.oneShotToggle = document.getElementById('oneShotToggle'); // New one-shot toggle button

        // Main elements

        this.header = document.getElementById('header');

        this.collapseHeader = document.getElementById('collapseHeader');

        this.chatContainer = document.getElementById('chatContainer');

        this.messagesContainer = document.getElementById('messages');

        // Header status elements

        this.modelStatus = document.getElementById('modelStatus');

        this.personaStatus = document.getElementById('personaStatus');

        // Input elements

        this.messageInput = document.getElementById('messageInput');

        this.sendMessage = document.getElementById('sendMessage');

        this.imageUpload = document.getElementById('imageUpload');

        this.fileInput = document.getElementById('fileInput');

        this.modelToggle = document.getElementById('modelToggle');

        // Token display

        this.tokenDisplay = document.getElementById('tokenDisplay');

        this.tokenCount = document.getElementById('tokenCount');

        this.tokenDetails = document.getElementById('tokenDetails');

        // Image preview

        this.imagePreview = document.getElementById('imagePreview');

        // Popups

        this.themePopup = document.getElementById('themePopup');

        this.personaPopup = document.getElementById('personaPopup');

        this.modelPopup = document.getElementById('modelPopup');

        this.apiKeyPopup = document.getElementById('apiKeyPopup');

        this.referencePopup = document.getElementById('referencePopup');

        // Status

        this.statusIndicator = document.getElementById('statusIndicator');

    }

    attachEventListeners() {

        // Sidebar events

        this.themeToggle.addEventListener('click', () => this.togglePopup('theme'));

        this.personaToggle.addEventListener('click', () => this.togglePopup('persona'));

        this.clearHistory.addEventListener('click', () => this.clearChatHistory());

        this.apiKeyToggle.addEventListener('click', () => this.togglePopup('apiKey'));

        this.oneShotToggle.addEventListener('click', () => this.toggleOneShotMode()); // New event listener

        // Header collapse

        this.collapseHeader.addEventListener('click', () => this.toggleHeader());

        // Input events

        this.messageInput.addEventListener('input', () => {

            this.autoResizeTextarea();

            this.updateTokenCount();

        });

        this.messageInput.addEventListener('keydown', (e) => this.handleKeyDown(e));

        this.sendMessage.addEventListener('click', () => this.sendUserMessage());

        this.imageUpload.addEventListener('click', () => this.fileInput.click());

        this.fileInput.addEventListener('change', (e) => this.handleFileUpload(e));

        this.modelToggle.addEventListener('click', () => this.togglePopup('model'));

        // Theme options

        document.querySelectorAll('.theme-option').forEach(btn => {

            btn.addEventListener('click', (e) => this.setTheme(e.target.dataset.theme));

        });

        // Persona options

        document.querySelectorAll('.persona-option').forEach(btn => {

            btn.addEventListener('click', (e) => this.setPersona(e.target.dataset.persona));

        });

        // Model options

        document.querySelectorAll('.model-option').forEach(btn => {

            btn.addEventListener('click', (e) => {

                this.setModel(e.target.dataset.model, e.target.dataset.api);

            });

        });

        // API key management

        document.getElementById('saveApiKeys').addEventListener('click', () => this.saveApiKeys());

        document.getElementById('showApiKeys').addEventListener('click', () => this.toggleApiKeysVisibility());

        // Custom prompt

        document.getElementById('saveCustomPrompt').addEventListener('click', () => this.saveCustomPrompt());

        // Reference popup

        document.getElementById('closeReferencePopup').addEventListener('click', () => this.closeReferencePopup());

        document.getElementById('openReference').addEventListener('click', () => this.openReference());

        document.getElementById('copyReference').addEventListener('click', () => this.copyReference());

        // Close popups when clicking outside

        document.addEventListener('click', (e) => this.handleOutsideClick(e));

        // Prevent popup close when clicking inside

        document.querySelectorAll('.popup-content').forEach(content => {

            content.addEventListener('click', (e) => e.stopPropagation());

        });

    }

    // New method to toggle one-shot mode

    toggleOneShotMode() {

        this.oneShotMode = !this.oneShotMode;

        localStorage.setItem('oneShotMode', this.oneShotMode.toString());

        this.updateOneShotButton();

        const statusText = this.oneShotMode ? 'One-shot mode enabled' : 'One-shot mode disabled';

        const statusType = this.oneShotMode ? 'success' : 'info';

        this.showStatus(statusText, statusType);

    }

    // New method to update one-shot button appearance

    updateOneShotButton() {

        if (this.oneShotToggle) {

            if (this.oneShotMode) {

                this.oneShotToggle.classList.add('active');

            } else {

                this.oneShotToggle.classList.remove('active');

            }

        }

    }

    updateHeaderStatus() {

        const modelName = this.getModelDisplayName();

        const personaName = this.personas[this.currentPersona]?.name || 'Unknown';

        this.modelStatus.textContent = `Model: ${modelName}`;

        this.personaStatus.textContent = `Persona: ${personaName}`;

    }

    getModelDisplayName() {

        const apiModels = this.models[this.currentAPI];

        const model = apiModels?.find(m => m.value === this.currentModel);

        return model ? model.name : this.currentModel;

    }

    updateTokenCount() {

        const message = this.messageInput.value.trim();

        if (!message) {

            this.tokenDisplay.classList.add('hidden');

            return;

        }

        // Rough token estimation (4 characters ≈ 1 token)

        const estimatedTokens = Math.ceil(message.length / 4);

        const systemPrompt = this.getSystemPrompt();

        const systemTokens = Math.ceil(systemPrompt.length / 4);

        this.tokenCount.textContent = `Tokens: ${estimatedTokens}`;

        this.tokenDetails.textContent = `System: ${systemTokens} | Input: ${estimatedTokens}`;

        this.tokenDisplay.classList.remove('hidden');

    }

    togglePopup(type) {

        const popups = ['theme', 'persona', 'model', 'apiKey'];

        // Close all other popups first

        popups.forEach(popupType => {

            if (popupType !== type) {

                const popup = document.getElementById(`${popupType}Popup`);

                if (popup) {

                    popup.classList.add('hidden');

                }

            }

        });

        // Toggle the requested popup

        const popup = document.getElementById(`${type}Popup`);

        if (popup) {

            popup.classList.toggle('hidden');

            // Show custom prompt section if customized persona is selected

            if (type === 'persona') {

                const customSection = document.getElementById('customPromptSection');

                if (this.currentPersona === 'customized') {

                    customSection.classList.remove('hidden');

                    document.getElementById('customPrompt').value = this.customPrompt;

                } else {

                    customSection.classList.add('hidden');

                }

            }

            // Load current API keys if showing API popup

            if (type === 'apiKey') {

                document.getElementById('perplexityApiKey').value = this.apiKeys.perplexity;

                document.getElementById('moonshotApiKey').value = this.apiKeys.moonshot;

            }

        }

    }

    handleOutsideClick(e) {

        if (e.target.classList.contains('popup')) {

            e.target.classList.add('hidden');

        }

    }

    toggleHeader() {

        this.header.classList.toggle('collapsed');

        const btn = this.collapseHeader.querySelector('span');

        btn.textContent = this.header.classList.contains('collapsed') ? '+' : '−';

    }

    autoResizeTextarea() {

        const textarea = this.messageInput;

        textarea.style.height = 'auto';

        textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';

    }

    resetTextareaSize() {

        this.messageInput.style.height = 'auto';

        this.messageInput.rows = 1;

        this.tokenDisplay.classList.add('hidden');

    }

    handleKeyDown(e) {

        if (e.key === 'Enter' && !e.shiftKey) {

            e.preventDefault();

            this.sendUserMessage();

        }

    }

    setTheme(theme) {

        document.documentElement.setAttribute('data-color-scheme', theme);

        localStorage.setItem('theme', theme);

        this.updateThemeIcon(theme);

        this.togglePopup('theme');

        this.updateThemeOptions();

        // Re-highlight code blocks for theme change

        setTimeout(() => {

            document.querySelectorAll('pre code').forEach((block) => {

                if (window.hljs) {

                    hljs.highlightBlock(block);

                }

            });

        }, 100);

    }

    updateThemeIcon(theme) {

        const icon = this.themeToggle.querySelector('.icon');

        icon.textContent = theme === 'dark' ? '🌙' : '☀️';

    }

    updateThemeOptions() {

        const currentTheme = document.documentElement.getAttribute('data-color-scheme') || 'light';

        document.querySelectorAll('.theme-option').forEach(btn => {

            btn.classList.toggle('active', btn.dataset.theme === currentTheme);

        });

    }

    setPersona(persona) {

        this.currentPersona = persona;

        localStorage.setItem('currentPersona', persona);

        this.updatePersonaOptions();

        this.updateHeaderStatus();

        if (persona === 'customized') {

            const customSection = document.getElementById('customPromptSection');

            customSection.classList.remove('hidden');

        } else {

            this.togglePopup('persona');

        }

    }

    updatePersonaOptions() {

        document.querySelectorAll('.persona-option').forEach(btn => {

            btn.classList.toggle('active', btn.dataset.persona === this.currentPersona);

        });

    }

    setModel(model, api) {

        this.currentModel = model;

        this.currentAPI = api;

        localStorage.setItem('currentModel', model);

        localStorage.setItem('currentAPI', api);

        this.updateModelOptions();

        this.updateHeaderStatus();

        this.togglePopup('model');

    }

    updateModelOptions() {

        document.querySelectorAll('.model-option').forEach(btn => {

            const isActive = btn.dataset.model === this.currentModel && btn.dataset.api === this.currentAPI;

            btn.classList.toggle('active', isActive);

        });

    }

    saveCustomPrompt() {

        this.customPrompt = document.getElementById('customPrompt').value;

        localStorage.setItem('customPrompt', this.customPrompt);

        this.togglePopup('persona');

        this.showStatus('Custom prompt saved', 'success');

    }

    saveApiKeys() {

        this.apiKeys.perplexity = document.getElementById('perplexityApiKey').value.trim();

        this.apiKeys.moonshot = document.getElementById('moonshotApiKey').value.trim();

        localStorage.setItem('perplexity_api_key', this.apiKeys.perplexity);

        localStorage.setItem('moonshot_api_key', this.apiKeys.moonshot);

        this.togglePopup('apiKey');

        this.showStatus('API keys saved', 'success');

    }

    toggleApiKeysVisibility() {

        const perplexityInput = document.getElementById('perplexityApiKey');

        const moonshotInput = document.getElementById('moonshotApiKey');

        const button = document.getElementById('showApiKeys');

        if (perplexityInput.type === 'password') {

            perplexityInput.type = 'text';

            moonshotInput.type = 'text';

            button.textContent = 'Hide';

        } else {

            perplexityInput.type = 'password';

            moonshotInput.type = 'password';

            button.textContent = 'Show/Hide';

        }

    }

    clearChatHistory() {

        if (confirm('Are you sure you want to clear the chat history?')) {

            this.messages = [];

            this.references = {};

            this.renderMessages();

            this.showStatus('Chat history cleared', 'info');

        }

    }

    loadTheme() {

        const theme = localStorage.getItem('theme') || 'light';

        document.documentElement.setAttribute('data-color-scheme', theme);

        this.updateThemeIcon(theme);

    }

    loadSettings() {

        this.currentPersona = localStorage.getItem('currentPersona') || 'allrounder';

        this.currentModel = localStorage.getItem('currentModel') || 'sonar';

        this.currentAPI = localStorage.getItem('currentAPI') || 'perplexity';

        this.customPrompt = localStorage.getItem('customPrompt') || '';

        this.apiKeys.moonshot = localStorage.getItem('moonshot_api_key') || '';

        // Load one-shot mode setting

        this.oneShotMode = localStorage.getItem('oneShotMode') === 'true';

    }

    updateUI() {

        this.updateThemeOptions();

        this.updatePersonaOptions();

        this.updateModelOptions();

        this.updateOneShotButton();

    }

    // Enhanced file upload with image preview

    handleFileUpload(e) {

        const file = e.target.files[0];

        if (file && file.type.startsWith('image/')) {

            const reader = new FileReader();

            reader.onload = (e) => {

                this.uploadedImage = e.target.result;

                this.showImagePreview(e.target.result);

                this.showStatus('Image uploaded successfully', 'success');

            };

            reader.readAsDataURL(file);

        } else if (file) {

            this.showStatus('Please select an image file', 'error');

        }

    }

    // Show image preview in input area

    showImagePreview(imageSrc) {

        if (!this.imagePreview) {

            // Create image preview element if it doesn't exist

            this.imagePreview = document.createElement('div');

            this.imagePreview.id = 'imagePreview';

            this.imagePreview.className = 'image-preview';

            // Insert before the input wrapper

            const inputArea = document.querySelector('.input-area');

            inputArea.insertBefore(this.imagePreview, inputArea.firstChild);

        }

        this.imagePreview.innerHTML = `

            <div class="preview-container">

                <img src="${imageSrc}" alt="Image preview" class="preview-image">

                <button class="remove-image-btn" onclick="window.chatApp.removeImagePreview()" title="Remove image">×</button>

            </div>

        `;

        this.imagePreview.classList.remove('hidden');

    }

    // Remove image preview

    removeImagePreview() {

        if (this.imagePreview) {

            this.imagePreview.classList.add('hidden');

            this.imagePreview.innerHTML = '';

        }

        this.uploadedImage = null;

        this.fileInput.value = '';

        this.showStatus('Image removed', 'info');

    }

    async sendUserMessage() {

        const message = this.messageInput.value.trim();

        if (!message && !this.uploadedImage) return;

        if (this.isLoading) return;

        // Clear chat history if one-shot mode is enabled (before adding new message)

        if (this.oneShotMode && this.messages.length > 0) {

            this.messages = [];

            this.references = {};

            this.renderMessages();

        }

        // Add user message

        const userMessage = {

            role: 'user',

            content: message,

            image: this.uploadedImage,

            timestamp: new Date()

        };

        this.messages.push(userMessage);

        // Clear input and reset size

        this.messageInput.value = '';

        this.resetTextareaSize();

        this.removeImagePreview(); // Clear image preview

        this.uploadedImage = null;

        this.fileInput.value = '';

        this.renderMessages();

        // Check for API key

        const currentApiKey = this.apiKeys[this.currentAPI];

        if (!currentApiKey) {

            this.showStatus(`No ${this.currentAPI} API key set - showing mock response`, 'warning');

            this.setLoading(true);

            // Show mock response after delay

            setTimeout(() => {

                const mockResponse = {

                    role: 'assistant',

                    content: this.generateMockResponse(message),

                    timestamp: new Date(),

                    // Add mock token usage for testing

                    tokenUsage: {

                        prompt_tokens: 25,

                        completion_tokens: 150,

                        total_tokens: 175,

                        search_context_size: "low"

                    }

                };

                this.messages.push(mockResponse);

                this.renderMessages();

                this.setLoading(false);

            }, 1500);

            return;

        }

        this.setLoading(true);

        try {

            const response = await this.callAPI(message);

            const assistantMessage = {

                role: 'assistant',

                content: response.content,

                timestamp: new Date(),

                tokenUsage: response.tokenUsage,

                searchResults: response.searchResults || [],

                citations: response.citations || []

            };

            this.messages.push(assistantMessage);

            this.renderMessages();

        } catch (error) {

            console.error('API Error:', error);

            this.showStatus('Error: ' + error.message, 'error');

            // Show fallback mock response on API error

            const fallbackResponse = {

                role: 'assistant',

                content: this.generateMockResponse(message),

                timestamp: new Date(),

                tokenUsage: {

                    prompt_tokens: 25,

                    completion_tokens: 150,

                    total_tokens: 175,

                    search_context_size: "low"

                }

            };

            this.messages.push(fallbackResponse);

            this.renderMessages();

        } finally {

            this.setLoading(false);

        }

    }

    generateMockResponse(userMessage) {

        const responses = [

            `Thank you for your message: "${userMessage}". This is a mock response since no API key is configured. Here's some information with references [1] and [2] for testing the clickable reference system.

## Code Example

Here's a sample JavaScript function:

\`\`\`javascript

function greetUser(name) {

    console.log("Hello, " + name + "!");

    return "Welcome to the chat!";

}

// Usage

greetUser("User");

\`\`\`

And some inline \`code\` for testing.

> This is a blockquote for testing markdown rendering.

**Key Points:**

1. First important point

2. Second important point  

3. Third important point

References:

[1] https://developer.mozilla.org/en-US/docs/Web/JavaScript

[2] https://www.example.com/api-documentation`,

            `I understand your query about "${userMessage}". Since this is a demonstration mode, I'll provide a comprehensive response with various formatting elements.

**Key Points:**

1. First important point with reference [1]

2. Second point with reference [2]  

3. Third point with another reference [3]

### Python Code Sample

\`\`\`python

def calculate_fibonacci(n):

    if n <= 1:

        return n

    else:

        return calculate_fibonacci(n-1) + calculate_fibonacci(n-2)

# Calculate the 10th Fibonacci number

result = calculate_fibonacci(10)

print(f"The 10th Fibonacci number is: {result}")

\`\`\`

### SQL Query Example

\`\`\`sql

SELECT users.name, COUNT(orders.id) as order_count

FROM users

LEFT JOIN orders ON users.id = orders.user_id

WHERE users.created_at >= '2024-01-01'

GROUP BY users.id, users.name

ORDER BY order_count DESC

LIMIT 10;

\`\`\`

*Note: This is a mock response for testing purposes.*

References:

[1] https://docs.python.org/3/tutorial/

[2] https://www.postgresql.org/docs/

[3] https://github.com/example/project`,

            `Your question "${userMessage}" is interesting. Let me provide a detailed analysis with multiple references and code examples.

## Analysis

Based on current research [1], this topic involves several key considerations referenced in studies [2] and [3].

**Important Steps:**

1. Initial assessment and planning

2. Implementation of core features

3. Testing and validation

4. Documentation and deployment

### Configuration Example

\`\`\`json

{

  "apiVersion": "v1",

  "kind": "ConfigMap",

  "metadata": {

    "name": "example-config",

    "namespace": "default"

  },

  "data": {

    "database.url": "mongodb://localhost:27017/mydb",

    "cache.ttl": "3600",

    "debug.enabled": "true"

  }

}

\`\`\`

### Shell Script

\`\`\`bash

#!/bin/bash

# Backup script with error handling

BACKUP_DIR="/var/backups/$(date +%Y%m%d)"

SOURCE_DIR="/opt/application/data"

mkdir -p "$BACKUP_DIR"

if [ $? -eq 0 ]; then

    tar -czf "$BACKUP_DIR/backup-$(date +%H%M%S).tar.gz" "$SOURCE_DIR"

    echo "Backup completed successfully"

else

    echo "Error: Could not create backup directory" >&2

    exit 1

fi

\`\`\`

> Important: Always test backup procedures before relying on them in production.

References:

[1] https://research.example.com/best-practices

[2] https://stackoverflow.com/questions/example

[3] https://www.example.org/documentation/guide`

        ];

        return responses[Math.floor(Math.random() * responses.length)];

    }

    buildMessagesForAPI() {

        const systemPrompt = this.getSystemPrompt();

        const apiMessages = [

            { role: 'system', content: systemPrompt }

        ];

        // Include recent messages (last 10 to keep within context limits)

        const recentMessages = this.messages.slice(-10);

        for (const msg of recentMessages) {

            if (msg.role === 'user') {

                if (msg.image && msg.content) {

                    apiMessages.push({

                        role: 'user',

                        content: [

                            { type: 'text', text: msg.content },

                            { type: 'image_url', image_url: { url: msg.image } }

                        ]

                    });

                } else if (msg.image) {

                    apiMessages.push({

                        role: 'user',

                        content: [

                            { type: 'image_url', image_url: { url: msg.image } }

                        ]

                    });

                } else if (msg.content) {

                    apiMessages.push({

                        role: 'user',

                        content: msg.content

                    });

                }

            } else if (msg.role === 'assistant' && msg.content) {

                apiMessages.push({

                    role: 'assistant',

                    content: msg.content

                });

            }

        }

        return apiMessages;

    }

    async callAPI(message) {

        const messages = this.buildMessagesForAPI();

        const endpoint = this.apiEndpoints[this.currentAPI];

        const apiKey = this.apiKeys[this.currentAPI];

        const requestBody = {

            model: this.currentModel,

            messages: messages,

            max_tokens: 5000,

            temperature: 0.3,

            stream: false

        };

        // Add API-specific parameters

        if (this.currentAPI === 'perplexity') {

            // Perplexity specific settings - no additional params needed

        } else if (this.currentAPI === 'moonshot') {

            // Moonshot specific settings

            requestBody.temperature = 0.3;

        }

        const response = await fetch(endpoint, {

            method: 'POST',

            headers: {

                'Content-Type': 'application/json',

                'Authorization': `Bearer ${apiKey}`

            },

            body: JSON.stringify(requestBody)

        });

        if (!response.ok) {

            const errorData = await response.json().catch(() => ({}));

            throw new Error(errorData.error?.message || `HTTP ${response.status}: ${response.statusText}`);

        }

        const data = await response.json();

        // Extract content and metadata

        const content = data.choices[0]?.message?.content || 'No response received.';

        const tokenUsage = data.usage || {};

        const searchResults = data.search_results || [];

        const citations = data.citations || [];

        return {

            content,

            tokenUsage,

            searchResults,

            citations

        };

    }

    getSystemPrompt() {

        if (this.currentPersona === 'customized') {

            return this.customPrompt || 'You are a helpful AI assistant.';

        }

        return this.personas[this.currentPersona]?.prompt || 'You are a helpful AI assistant.';

    }

    // Enhanced reference extraction from API response

    extractReferencesFromResponse(message) {

        const references = {};

        // Extract from search results if available

        if (message.searchResults && message.searchResults.length > 0) {

            message.searchResults.forEach((result, index) => {

                const refNum = (index + 1).toString();

                references[refNum] = {

                    url: result.url,

                    title: result.title,

                    date: result.date,

                    snippet: result.snippet

                };

            });

        }

        // Extract from citations if available

        if (message.citations && message.citations.length > 0) {

            message.citations.forEach((citation, index) => {

                const refNum = (index + 1).toString();

                // If we don't have this reference from search results, add it

                if (!references[refNum]) {

                    references[refNum] = {

                        url: citation,

                        title: this.extractDomainFromUrl(citation),

                        date: null,

                        snippet: null

                    };

                }

            });

        }

        // Also extract from content using original method as fallback

        const contentRefs = this.extractReferencesFromContent(message.content);

        Object.assign(references, contentRefs);

        return references;

    }

    // Original reference extraction from content

    extractReferencesFromContent(content) {

        const references = {};

        // Look for "References:" section first

        const referencesSection = content.match(/References?:\s*([\s\S]*?)(?:\n\n|$)/i);

        if (referencesSection) {

            const refLines = referencesSection[1].split('\n');

            refLines.forEach(line => {

                const refMatch = line.match(/\[(\d+)\]\s*(.+)/);

                if (refMatch) {

                    const refNum = refMatch[1];

                    let url = refMatch[2].trim();

                    if (url.includes('http') || url.includes('www.') || url.includes('.com') || url.includes('.org') || url.includes('.net')) {

                        if (!url.startsWith('http')) {

                            url = url.startsWith('www.') ? `https://${url}` : `https://www.${url}`;

                        }

                        references[refNum] = {

                            url: url,

                            title: this.extractDomainFromUrl(url),

                            date: null,

                            snippet: null

                        };

                    }

                }

            });

        }

        return references;

    }

    extractDomainFromUrl(url) {

        try {

            const urlObj = new URL(url);

            return urlObj.hostname;

        } catch (e) {

            return url;

        }

    }

    renderMessages() {

        this.messagesContainer.innerHTML = '';

        this.messages.forEach((message, index) => {

            const messageEl = this.createMessageElement(message, index);

            this.messagesContainer.appendChild(messageEl);

        });

        this.chatContainer.scrollTop = this.chatContainer.scrollHeight;

    }

    createMessageElement(message, index) {

        const messageEl = document.createElement('div');

        messageEl.className = `message ${message.role}`;

        const headerEl = document.createElement('div');

        headerEl.className = 'message-header';

        const roleEl = document.createElement('span');

        roleEl.className = 'message-role';

        roleEl.textContent = message.role === 'user' ? 'You' : 'Assistant';

        headerEl.appendChild(roleEl);

        const copyBtn = document.createElement('button');

        copyBtn.className = 'copy-btn';

        copyBtn.innerHTML = '📋';

        copyBtn.title = 'Copy message';

        copyBtn.addEventListener('click', () => this.copyMessage(message.content));

        headerEl.appendChild(copyBtn);

        const contentEl = document.createElement('div');

        contentEl.className = 'message-content';

        if (message.image && message.role === 'user') {

            const imgEl = document.createElement('img');

            imgEl.src = message.image;

            imgEl.className = 'message-image';

            imgEl.alt = 'Uploaded image';

            contentEl.appendChild(imgEl);

        }

        if (message.content) {

            // Extract and store references for this message

            if (message.role === 'assistant') {

                const msgReferences = this.extractReferencesFromResponse(message);

                Object.assign(this.references, msgReferences);

            }

            const renderedContent = this.renderEnhancedMarkdown(message.content);

            contentEl.innerHTML += renderedContent;

            // Add click handlers to reference links

            if (message.role === 'assistant') {

                this.attachReferenceHandlers(contentEl);

            }

            // Highlight code blocks if hljs is available

            if (window.hljs) {

                contentEl.querySelectorAll('pre code').forEach((block) => {

                    hljs.highlightBlock(block);

                });

            }

        }

        messageEl.appendChild(headerEl);

        messageEl.appendChild(contentEl);

        // Add token usage display in the right corner for assistant messages

        if (message.role === 'assistant' && message.tokenUsage) {

            const tokenUsageEl = this.createTokenUsageCornerElement(message.tokenUsage);

            messageEl.appendChild(tokenUsageEl);

        }

        return messageEl;

    }

    // Create token usage element for the right corner of the message

    createTokenUsageCornerElement(tokenUsage) {

        const tokenEl = document.createElement('div');

        tokenEl.className = 'token-usage-corner';

        let tokenInfo = [];

        if (tokenUsage.total_tokens) {

            tokenInfo.push(`${tokenUsage.total_tokens}T`);

        }

        if (tokenUsage.search_context_size) {

            tokenInfo.push(`${tokenUsage.search_context_size}S`);

        }

        tokenEl.textContent = tokenInfo.length > 0 ? tokenInfo.join(' • ') : '';

        tokenEl.title = this.getDetailedTokenInfo(tokenUsage);

        return tokenEl;

    }

    // Get detailed token info for tooltip

    getDetailedTokenInfo(tokenUsage) {

        let details = [];

        if (tokenUsage.prompt_tokens) details.push(`Input: ${tokenUsage.prompt_tokens}`);

        if (tokenUsage.completion_tokens) details.push(`Output: ${tokenUsage.completion_tokens}`);

        if (tokenUsage.total_tokens) details.push(`Total: ${tokenUsage.total_tokens}`);

        if (tokenUsage.search_context_size) details.push(`Search: ${tokenUsage.search_context_size}`);

        if (tokenUsage.reasoning_tokens) details.push(`Reasoning: ${tokenUsage.reasoning_tokens}`);

        if (tokenUsage.citation_tokens) details.push(`Citations: ${tokenUsage.citation_tokens}`);

        return details.join('\n');

    }

    renderEnhancedMarkdown(text) {

        // Pre-process text to fix common list issues

        let processedText = text;

        // Ensure proper spacing for ordered lists

        processedText = processedText.replace(/(^|\n)(\d+)\.\s/gm, '$1$2. ');

        // Ensure proper spacing for unordered lists

        processedText = processedText.replace(/(^|\n)([*+-])\s/gm, '$1$2 ');

        // First, convert with Showdown

        let html = this.converter.makeHtml(processedText);

        // Fix any remaining list numbering issues

        html = html.replace(/<ol[^>]*>/g, '<ol>');

        html = html.replace(/<ol>\s*<li[^>]*>1\./g, '<ol><li>');

        // Enhance code blocks with headers and copy buttons

        html = html.replace(/<pre><code class="([^"]*)"([^>]*)>([\s\S]*?)<\/code><\/pre>/g, (match, langClass, attrs, code) => {

            const language = langClass ? langClass.replace('language-', '') : 'text';

            const lines = code.split('\n').length - 1;

            const showLineNumbers = lines > 10;

            const codeId = 'code-' + Math.random().toString(36).substr(2, 9);

            let codeBlockHtml = `

                <div class="code-block">

                    <div class="code-header">

                        <span class="code-language">${language}</span>

                        <button class="code-copy-btn" onclick="copyCodeBlock('${codeId}')">Copy</button>

                    </div>`;

            if (showLineNumbers) {

                const lineNumbers = Array.from({length: lines}, (_, i) => i + 1).join('\n');

                codeBlockHtml += `

                    <div class="code-with-lines">

                        <div class="line-numbers">${lineNumbers}</div>

                        <pre><code id="${codeId}" class="${langClass}"${attrs}>${code}</code></pre>

                    </div>`;

            } else {

                codeBlockHtml += `<pre><code id="${codeId}" class="${langClass}"${attrs}>${code}</code></pre>`;

            }

            codeBlockHtml += `</div>`;

            return codeBlockHtml;

        });

        // Make reference numbers clickable (keep them in the text)

        html = html.replace(/\[(\d+)\]/g, '<span class="reference-link" data-ref="$1">[$1]</span>');

        return html;

    }

    attachReferenceHandlers(contentEl) {

        const referenceLinks = contentEl.querySelectorAll('.reference-link');

        referenceLinks.forEach(link => {

            link.addEventListener('click', (e) => {

                const refNum = e.target.dataset.ref;

                this.showReferencePopup(refNum);

            });

        });

    }

    showReferencePopup(refNum) {

        const reference = this.references[refNum];

        if (!reference) {

            this.showStatus('Reference not found', 'error');

            return;

        }

        this.currentReference = { num: refNum, ...reference };

        document.getElementById('referenceTitle').textContent = `Reference [${refNum}]`;

        let referenceContent = '';

        if (reference.title && reference.title !== reference.url) {

            referenceContent += `<strong>Title:</strong> ${reference.title}<br>`;

        }

        referenceContent += `<strong>URL:</strong> ${reference.url}`;

        if (reference.date) {

            referenceContent += `<br><strong>Date:</strong> ${reference.date}`;

        }

        if (reference.snippet) {

            referenceContent += `<br><strong>Snippet:</strong> ${reference.snippet}`;

        }

        document.getElementById('referenceUrl').innerHTML = referenceContent;

        this.referencePopup.classList.remove('hidden');

    }

    closeReferencePopup() {

        this.referencePopup.classList.add('hidden');

    }

    openReference() {

        if (this.currentReference.url) {

            window.open(this.currentReference.url, '_blank');

            this.closeReferencePopup();

        }

    }

    copyReference() {

        if (this.currentReference.url) {

            this.copyToClipboard(this.currentReference.url);

            this.showStatus('Reference URL copied', 'success');

            this.closeReferencePopup();

        }

    }

    async copyMessage(content) {

        await this.copyToClipboard(content);

        this.showStatus('Copied to clipboard', 'success');

    }

    async copyToClipboard(text) {

        try {

            await navigator.clipboard.writeText(text);

        } catch (error) {

            // Fallback for older browsers

            const textArea = document.createElement('textarea');

            textArea.value = text;

            document.body.appendChild(textArea);

            textArea.focus();

            textArea.select();

            try {

                document.execCommand('copy');

            } catch (fallbackError) {

                console.error('Failed to copy:', fallbackError);

            }

            document.body.removeChild(textArea);

        }

    }

    setLoading(loading) {

        this.isLoading = loading;

        this.sendMessage.disabled = loading;

        if (loading) {

            const loadingEl = document.createElement('div');

            loadingEl.className = 'message assistant loading-message';

            loadingEl.innerHTML = '<div class="loading">Loading response...</div>';

            this.messagesContainer.appendChild(loadingEl);

            this.chatContainer.scrollTop = this.chatContainer.scrollHeight;

        } else {

            const loadingMsg = document.querySelector('.loading-message');

            if (loadingMsg) {

                loadingMsg.remove();

            }

        }

    }

    showStatus(message, type = 'info') {

        this.statusIndicator.textContent = message;

        this.statusIndicator.className = `status status--${type} show`;

        setTimeout(() => {

            this.statusIndicator.classList.remove('show');

            this.statusIndicator.classList.add('hidden');

        }, 3000);

    }

}

// Global function for code copy buttons

window.copyCodeBlock = function(codeId) {

    const codeElement = document.getElementById(codeId);

    if (codeElement) {

        const text = codeElement.textContent;

        navigator.clipboard.writeText(text).then(() => {

            // Find the copy button for this code block

            const codeBlock = codeElement.closest('.code-block');

            const copyBtn = codeBlock.querySelector('.code-copy-btn');

            if (copyBtn) {

                const originalText = copyBtn.textContent;

                copyBtn.textContent = 'Copied!';

                setTimeout(() => {

                    copyBtn.textContent = originalText;

                }, 2000);

            }

        }).catch(err => {

            console.error('Failed to copy code:', err);

        });

    }

};

// Initialize the chat application and make it globally available

document.addEventListener('DOMContentLoaded', () => {

    window.chatApp = new MultiAPIChat();

});
    </script>
</body>
</html>