<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-API Chat Interface (v2.1)</title>

    <!-- External Dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/showdown@2.1.0/dist/showdown.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">

    <!-- Embedded CSS -->
    <style>
:root {
  /* Primitive Color Tokens */
  --color-white: rgba(255, 255, 255, 1);
  --color-black: rgba(0, 0, 0, 1);
  --color-cream-50: rgba(252, 252, 249, 1);
  --color-cream-100: rgba(255, 255, 253, 1);
  --color-gray-200: rgba(245, 245, 245, 1);
  --color-gray-300: rgba(167, 169, 169, 1);
  --color-gray-400: rgba(119, 124, 124, 1);
  --color-slate-500: rgba(98, 108, 113, 1);
  --color-brown-600: rgba(94, 82, 64, 1);
  --color-charcoal-700: rgba(31, 33, 33, 1);
  --color-charcoal-800: rgba(38, 40, 40, 1);
  --color-slate-900: rgba(19, 52, 59, 1);
  --color-teal-300: rgba(50, 184, 198, 1);
  --color-teal-400: rgba(45, 166, 178, 1);
  --color-teal-500: rgba(33, 128, 141, 1);
  --color-teal-600: rgba(29, 116, 128, 1);
  --color-teal-700: rgba(26, 104, 115, 1);
  --color-teal-800: rgba(41, 150, 161, 1);
  --color-red-400: rgba(255, 84, 89, 1);
  --color-red-500: rgba(192, 21, 47, 1);
  --color-orange-400: rgba(230, 129, 97, 1);
  --color-orange-500: rgba(168, 75, 47, 1);

  /* RGB versions for opacity control */
  --color-brown-600-rgb: 94, 82, 64;
  --color-teal-500-rgb: 33, 128, 141;
  --color-slate-900-rgb: 19, 52, 59;
  --color-slate-500-rgb: 98, 108, 113;
  --color-red-500-rgb: 192, 21, 47;
  --color-red-400-rgb: 255, 84, 89;
  --color-orange-500-rgb: 168, 75, 47;
  --color-orange-400-rgb: 230, 129, 97;

  /* Background color tokens (Light Mode) */
  --color-bg-1: rgba(59, 130, 246, 0.08); /* Light blue */
  --color-bg-2: rgba(245, 158, 11, 0.08); /* Light yellow */
  --color-bg-3: rgba(34, 197, 94, 0.08); /* Light green */
  --color-bg-4: rgba(239, 68, 68, 0.08); /* Light red */
  --color-bg-5: rgba(147, 51, 234, 0.08); /* Light purple */
  --color-bg-6: rgba(249, 115, 22, 0.08); /* Light orange */
  --color-bg-7: rgba(236, 72, 153, 0.08); /* Light pink */
  --color-bg-8: rgba(6, 182, 212, 0.08); /* Light cyan */

  /* Semantic Color Tokens (Light Mode) */
  --color-background: var(--color-cream-50);
  --color-surface: var(--color-cream-100);
  --color-text: var(--color-slate-900);
  --color-text-secondary: var(--color-slate-500);
  --color-primary: var(--color-teal-500);
  --color-primary-hover: var(--color-teal-600);
  --color-primary-active: var(--color-teal-700);
  --color-secondary: rgba(var(--color-brown-600-rgb), 0.12);
  --color-secondary-hover: rgba(var(--color-brown-600-rgb), 0.2);
  --color-secondary-active: rgba(var(--color-brown-600-rgb), 0.25);
  --color-border: rgba(var(--color-brown-600-rgb), 0.2);
  --color-btn-primary-text: var(--color-cream-50);
  --color-card-border: rgba(var(--color-brown-600-rgb), 0.12);
  --color-card-border-inner: rgba(var(--color-brown-600-rgb), 0.12);
  --color-error: var(--color-red-500);
  --color-success: var(--color-teal-500);
  --color-warning: var(--color-orange-500);
  --color-info: var(--color-slate-500);
  --color-focus-ring: rgba(var(--color-teal-500-rgb), 0.4);
  --color-select-caret: rgba(var(--color-slate-900-rgb), 0.8);

  /* Common style patterns */
  --focus-ring: 0 0 0 3px var(--color-focus-ring);
  --focus-outline: 2px solid var(--color-primary);
  --status-bg-opacity: 0.15;
  --status-border-opacity: 0.25;
  --select-caret-light: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23134252' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
  --select-caret-dark: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23f5f5f5' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");

  /* RGB versions for opacity control */
  --color-success-rgb: 33, 128, 141;
  --color-error-rgb: 192, 21, 47;
  --color-warning-rgb: 168, 75, 47;
  --color-info-rgb: 98, 108, 113;

  /* Typography */
  --font-family-base: "FKGroteskNeue", "Geist", "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
  --font-family-mono: "Berkeley Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
  --font-size-xs: 11px;
  --font-size-sm: 12px;
  --font-size-base: 14px;
  --font-size-md: 14px;
  --font-size-lg: 16px;
  --font-size-xl: 18px;
  --font-size-2xl: 20px;
  --font-size-3xl: 24px;
  --font-size-4xl: 30px;
  --font-weight-normal: 400;
  --font-weight-medium: 500;
  --font-weight-semibold: 550;
  --font-weight-bold: 600;
  --line-height-tight: 1.2;
  --line-height-normal: 1.5;
  --letter-spacing-tight: -0.01em;

  /* Spacing */
  --space-0: 0;
  --space-1: 1px;
  --space-2: 2px;
  --space-4: 4px;
  --space-6: 6px;
  --space-8: 8px;
  --space-10: 10px;
  --space-12: 12px;
  --space-16: 16px;
  --space-20: 20px;
  --space-24: 24px;
  --space-32: 32px;

  /* Border Radius */
  --radius-sm: 6px;
  --radius-base: 8px;
  --radius-md: 10px;
  --radius-lg: 12px;
  --radius-full: 9999px;

  /* Shadows */
  --shadow-xs: 0 1px 2px rgba(0, 0, 0, 0.02);
  --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.04), 0 1px 2px rgba(0, 0, 0, 0.02);
  --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.04), 0 2px 4px -1px rgba(0, 0, 0, 0.02);
  --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.04), 0 4px 6px -2px rgba(0, 0, 0, 0.02);
  --shadow-inset-sm: inset 0 1px 0 rgba(255, 255, 255, 0.15), inset 0 -1px 0 rgba(0, 0, 0, 0.03);

  /* Animation */
  --duration-fast: 150ms;
  --duration-normal: 250ms;
  --ease-standard: cubic-bezier(0.16, 1, 0.3, 1);

  /* Layout */
  --container-sm: 640px;
  --container-md: 768px;
  --container-lg: 1024px;
  --container-xl: 1280px;
}

/* Dark mode colors */
@media (prefers-color-scheme: dark) {
  :root {
    --color-gray-400-rgb: 119, 124, 124;
    --color-teal-300-rgb: 50, 184, 198;
    --color-gray-300-rgb: 167, 169, 169;
    --color-gray-200-rgb: 245, 245, 245;

    --color-bg-1: rgba(29, 78, 216, 0.15);
    --color-bg-2: rgba(180, 83, 9, 0.15);
    --color-bg-3: rgba(21, 128, 61, 0.15);
    --color-bg-4: rgba(185, 28, 28, 0.15);
    --color-bg-5: rgba(107, 33, 168, 0.15);
    --color-bg-6: rgba(194, 65, 12, 0.15);
    --color-bg-7: rgba(190, 24, 93, 0.15);
    --color-bg-8: rgba(8, 145, 178, 0.15);

    --color-background: var(--color-charcoal-700);
    --color-surface: var(--color-charcoal-800);
    --color-text: var(--color-gray-200);
    --color-text-secondary: rgba(var(--color-gray-300-rgb), 0.7);
    --color-primary: var(--color-teal-300);
    --color-primary-hover: var(--color-teal-400);
    --color-primary-active: var(--color-teal-800);
    --color-secondary: rgba(var(--color-gray-400-rgb), 0.15);
    --color-secondary-hover: rgba(var(--color-gray-400-rgb), 0.25);
    --color-secondary-active: rgba(var(--color-gray-400-rgb), 0.3);
    --color-border: rgba(var(--color-gray-400-rgb), 0.3);
    --color-error: var(--color-red-400);
    --color-success: var(--color-teal-300);
    --color-warning: var(--color-orange-400);
    --color-info: var(--color-gray-300);
    --color-focus-ring: rgba(var(--color-teal-300-rgb), 0.4);
    --color-btn-primary-text: var(--color-slate-900);
    --color-card-border: rgba(var(--color-gray-400-rgb), 0.2);
    --color-card-border-inner: rgba(var(--color-gray-400-rgb), 0.15);
    --shadow-inset-sm: inset 0 1px 0 rgba(255, 255, 255, 0.1), inset 0 -1px 0 rgba(0, 0, 0, 0.15);
    --button-border-secondary: rgba(var(--color-gray-400-rgb), 0.2);
    --color-border-secondary: rgba(var(--color-gray-400-rgb), 0.2);
    --color-select-caret: rgba(var(--color-gray-200-rgb), 0.8);

    --color-success-rgb: var(--color-teal-300-rgb);
    --color-error-rgb: var(--color-red-400-rgb);
    --color-warning-rgb: var(--color-orange-400-rgb);
    --color-info-rgb: var(--color-gray-300-rgb);
  }
}

/* Data attribute for manual theme switching */
[data-color-scheme="dark"] {
  --color-gray-400-rgb: 119, 124, 124;
  --color-teal-300-rgb: 50, 184, 198;
  --color-gray-300-rgb: 167, 169, 169;
  --color-gray-200-rgb: 245, 245, 245;

  --color-bg-1: rgba(29, 78, 216, 0.15);
  --color-bg-2: rgba(180, 83, 9, 0.15);
  --color-bg-3: rgba(21, 128, 61, 0.15);
  --color-bg-4: rgba(185, 28, 28, 0.15);
  --color-bg-5: rgba(107, 33, 168, 0.15);
  --color-bg-6: rgba(194, 65, 12, 0.15);
  --color-bg-7: rgba(190, 24, 93, 0.15);
  --color-bg-8: rgba(8, 145, 178, 0.15);

  --color-background: var(--color-charcoal-700);
  --color-surface: var(--color-charcoal-800);
  --color-text: var(--color-gray-200);
  --color-text-secondary: rgba(var(--color-gray-300-rgb), 0.7);
  --color-primary: var(--color-teal-300);
  --color-primary-hover: var(--color-teal-400);
  --color-primary-active: var(--color-teal-800);
  --color-secondary: rgba(var(--color-gray-400-rgb), 0.15);
  --color-secondary-hover: rgba(var(--color-gray-400-rgb), 0.25);
  --color-secondary-active: rgba(var(--color-gray-400-rgb), 0.3);
  --color-border: rgba(var(--color-gray-400-rgb), 0.3);
  --color-error: var(--color-red-400);
  --color-success: var(--color-teal-300);
  --color-warning: var(--color-orange-400);
  --color-info: var(--color-gray-300);
  --color-focus-ring: rgba(var(--color-teal-300-rgb), 0.4);
  --color-btn-primary-text: var(--color-slate-900);
  --color-card-border: rgba(var(--color-gray-400-rgb), 0.15);
  --color-card-border-inner: rgba(var(--color-gray-400-rgb), 0.15);
  --shadow-inset-sm: inset 0 1px 0 rgba(255, 255, 255, 0.1), inset 0 -1px 0 rgba(0, 0, 0, 0.15);
  --color-border-secondary: rgba(var(--color-gray-400-rgb), 0.2);
  --color-select-caret: rgba(var(--color-gray-200-rgb), 0.8);

  --color-success-rgb: var(--color-teal-300-rgb);
  --color-error-rgb: var(--color-red-400-rgb);
  --color-warning-rgb: var(--color-orange-400-rgb);
  --color-info-rgb: var(--color-gray-300-rgb);
}

[data-color-scheme="light"] {
  --color-brown-600-rgb: 94, 82, 64;
  --color-teal-500-rgb: 33, 128, 141;
  --color-slate-900-rgb: 19, 52, 59;

  --color-background: var(--color-cream-50);
  --color-surface: var(--color-cream-100);
  --color-text: var(--color-slate-900);
  --color-text-secondary: var(--color-slate-500);
  --color-primary: var(--color-teal-500);
  --color-primary-hover: var(--color-teal-600);
  --color-primary-active: var(--color-teal-700);
  --color-secondary: rgba(var(--color-brown-600-rgb), 0.12);
  --color-secondary-hover: rgba(var(--color-brown-600-rgb), 0.2);
  --color-secondary-active: rgba(var(--color-brown-600-rgb), 0.25);
  --color-border: rgba(var(--color-brown-600-rgb), 0.2);
  --color-btn-primary-text: var(--color-cream-50);
  --color-card-border: rgba(var(--color-brown-600-rgb), 0.12);
  --color-card-border-inner: rgba(var(--color-brown-600-rgb), 0.12);
  --color-error: var(--color-red-500);
  --color-success: var(--color-teal-500);
  --color-warning: var(--color-orange-500);
  --color-info: var(--color-slate-500);
  --color-focus-ring: rgba(var(--color-teal-500-rgb), 0.4);

  --color-success-rgb: var(--color-teal-500-rgb);
  --color-error-rgb: var(--color-red-500-rgb);
  --color-warning-rgb: var(--color-orange-500-rgb);
  --color-info-rgb: var(--color-slate-500-rgb);
}

/* Base styles */
html {
  font-size: var(--font-size-base);
  font-family: var(--font-family-base);
  line-height: var(--line-height-normal);
  color: var(--color-text);
  background-color: var(--color-background);
  -webkit-font-smoothing: antialiased;
  box-sizing: border-box;
}

body { margin: 0; padding: 0; }
*, *::before, *::after { box-sizing: inherit; }

/* Typography */
h1, h2, h3, h4, h5, h6 {
  margin: 0;
  font-weight: var(--font-weight-semibold);
  line-height: var(--line-height-tight);
  color: var(--color-text);
  letter-spacing: var(--letter-spacing-tight);
}
h1 { font-size: var(--font-size-4xl); }
h2 { font-size: var(--font-size-3xl); }
h3 { font-size: var(--font-size-2xl); }
h4 { font-size: var(--font-size-xl); }
p { margin: 0 0 var(--space-16) 0; }
a { color: var(--color-primary); text-decoration: none; transition: color var(--duration-fast) var(--ease-standard); }
a:hover { color: var(--color-primary-hover); }

/* Buttons */
.btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: var(--space-8) var(--space-16);
  border-radius: var(--radius-base);
  font-size: var(--font-size-base);
  font-weight: 500;
  line-height: 1.5;
  cursor: pointer;
  transition: all var(--duration-normal) var(--ease-standard);
  border: none;
  text-decoration: none;
  position: relative;
}
.btn:focus-visible { outline: none; box-shadow: var(--focus-ring); }
.btn--primary { background: var(--color-primary); color: var(--color-btn-primary-text); }
.btn--primary:hover { background: var(--color-primary-hover); }
.btn--secondary { background: var(--color-secondary); color: var(--color-text); }
.btn--secondary:hover { background: var(--color-secondary-hover); }
.btn--sm { padding: var(--space-4) var(--space-12); font-size: var(--font-size-sm); border-radius: var(--radius-sm); }
.btn:disabled { opacity: 0.5; cursor: not-allowed; }

/* Form elements */
.form-control {
  display: block;
  width: 100%;
  padding: var(--space-8) var(--space-12);
  font-size: var(--font-size-md);
  line-height: 1.5;
  color: var(--color-text);
  background-color: var(--color-surface);
  border: 1px solid var(--color-border);
  border-radius: var(--radius-base);
  transition: border-color var(--duration-fast) var(--ease-standard), box-shadow var(--duration-fast) var(--ease-standard);
}
.form-control:focus { border-color: var(--color-primary); outline: var(--focus-outline); }
.form-label { display: block; margin-bottom: var(--space-8); font-weight: var(--font-weight-medium); font-size: var(--font-size-sm); }
.form-group { margin-bottom: var(--space-16); }

/* Range Input */
input[type="range"] {
    width: 100%;
    margin: var(--space-8) 0;
    cursor: pointer;
}

/* App Layout */
.app-container {
  display: flex;
  height: 100vh;
  background-color: var(--color-background);
}

/* Sidebar */
.sidebar {
  width: 50px;
  background-color: var(--color-surface);
  border-right: 1px solid var(--color-border);
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: var(--space-8) 0;
  gap: var(--space-16);
  position: fixed;
  left: 0;
  top: 0;
  height: 100vh;
  z-index: 100;
  box-shadow: var(--shadow-sm);
}

.sidebar-icon {
  width: 36px;
  height: 36px;
  border-radius: var(--radius-base);
  background-color: var(--color-secondary);
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all var(--duration-fast) var(--ease-standard);
  border: 1px solid var(--color-border);
  position: relative;
}
.sidebar-icon:hover { background-color: var(--color-secondary-hover); transform: translateY(-1px); box-shadow: var(--shadow-sm); }
.sidebar-icon.active { background-color: var(--color-primary); color: var(--color-btn-primary-text); }
.sidebar-icon .icon { font-size: var(--font-size-lg); }

/* Main Content */
.main-content {
  margin-left: 50px;
  flex: 1;
  display: flex;
  flex-direction: column;
  width: calc(100% - 50px);
  background-color: var(--color-background);
}

/* Header */
.header {
  background: linear-gradient(135deg, var(--color-bg-1), var(--color-bg-8));
  border-bottom: 1px solid var(--color-border);
  padding: var(--space-12) var(--space-16);
  display: flex;
  justify-content: space-between;
  align-items: center;
  z-index: 50;
}
.header-info { display: flex; flex-direction: column; gap: var(--space-4); }
.header-info h1 { font-size: var(--font-size-lg); font-weight: var(--font-weight-bold); }
.status-line { display: flex; align-items: center; gap: var(--space-8); font-size: var(--font-size-sm); color: var(--color-text-secondary); }
.collapse-btn {
  background: var(--color-secondary);
  border: 1px solid var(--color-border);
  border-radius: var(--radius-sm);
  width: 24px;
  height: 24px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  font-size: var(--font-size-sm);
  color: var(--color-text);
}
.header.collapsed { padding: var(--space-4) var(--space-16); }
.header.collapsed .header-info h1 { font-size: var(--font-size-sm); }

/* Chat Container */
.chat-container { flex: 1; overflow-y: auto; padding: var(--space-16) var(--space-12); background-color: var(--color-background); }
.messages-wrapper {
    width: 80%;
    min-width: 60%;
    margin: 0 auto;
    transition: width var(--duration-normal) var(--ease-standard);
}
@media (max-width: 768px) {
    .messages-wrapper {
        width: 100%;
        min-width: 100%;
    }
}
.messages { display: flex; flex-direction: column; gap: var(--space-16); min-height: 100%; }
.message {
  background-color: var(--color-surface);
  border-radius: var(--radius-lg);
  padding: var(--space-12);
  border: 1px solid var(--color-card-border);
  box-shadow: var(--shadow-xs);
  word-wrap: break-word;
  overflow-wrap: break-word;
  position: relative;
}
.message.user { background-color: var(--color-bg-1); border-color: var(--color-primary); margin-left: var(--space-8); }
.message.assistant { background-color: var(--color-surface); margin-right: var(--space-8); padding-top: var(--space-16); }
.message-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-8); font-size: var(--font-size-xs); color: var(--color-text-secondary); }
.message-role { font-weight: var(--font-weight-medium); text-transform: uppercase; letter-spacing: 0.5px; }
.message-content { font-size: var(--font-size-sm); line-height: var(--line-height-normal); color: var(--color-text); position: relative; z-index: 1; }
.message-image { max-width: 100%; height: auto; border-radius: var(--radius-base); margin: var(--space-8) 0; border: 1px solid var(--color-border); }

/* Copy Button */
.copy-btn {
  background-color: transparent;
  border: none;
  cursor: pointer;
  padding: var(--space-2);
  border-radius: var(--radius-sm);
  color: var(--color-text-secondary);
  transition: all var(--duration-fast) var(--ease-standard);
  display: flex;
  align-items: center;
  justify-content: center;
}
.copy-btn:hover {
  background-color: var(--color-secondary);
  color: var(--color-text);
}

/* Code Blocks */
.message-content pre {
  background-color: var(--color-secondary);
  padding: var(--space-12);
  border-radius: var(--radius-base);
  overflow-x: auto;
  font-size: var(--font-size-xs);
  border: 1px solid var(--color-border);
  font-family: var(--font-family-mono);
}
.code-block { position: relative; margin: var(--space-8) 0; }
.code-header {
  display: flex; justify-content: space-between; align-items: center;
  background-color: var(--color-secondary);
  padding: var(--space-6) var(--space-12);
  border-top-left-radius: var(--radius-base);
  border-top-right-radius: var(--radius-base);
  border: 1px solid var(--color-border);
  border-bottom: none;
  font-size: var(--font-size-xs);
  color: var(--color-text-secondary);
}
.code-copy-btn {
  background: var(--color-background);
  border: 1px solid var(--color-border);
  border-radius: var(--radius-sm);
  padding: var(--space-2) var(--space-6);
  font-size: var(--font-size-xs);
  cursor: pointer;
  color: var(--color-text);
}

/* Input Area */
.input-area { border-top: 1px solid var(--color-border); background-color: var(--color-surface); padding: var(--space-12); }
.input-wrapper {
  display: flex; align-items: flex-end; gap: var(--space-8);
  background-color: var(--color-background);
  border: 1px solid var(--color-border);
  border-radius: var(--radius-lg);
  padding: var(--space-8);
  transition: border-color var(--duration-fast) var(--ease-standard);
}
.input-wrapper:focus-within { border-color: var(--color-primary); }
#messageInput {
  flex: 1; border: none; outline: none; resize: none; background: transparent;
  font-family: var(--font-family-base); font-size: var(--font-size-sm);
  line-height: var(--line-height-normal); color: var(--color-text);
  min-height: 20px; max-height: 120px; overflow-y: auto;
}
.input-actions { display: flex; gap: var(--space-4); align-items: center; }
.action-btn {
  width: 28px; height: 28px; border: none; background-color: var(--color-secondary);
  border-radius: var(--radius-sm); cursor: pointer; display: flex; align-items: center;
  justify-content: center; transition: all var(--duration-fast) var(--ease-standard);
  font-size: var(--font-size-sm); color: var(--color-text);
}
.action-btn:hover { background-color: var(--color-secondary-hover); transform: translateY(-1px); }
.action-btn.hidden { display: none !important; }
.send-btn {
  width: 32px; height: 32px; border: none; background-color: var(--color-primary);
  border-radius: var(--radius-base); cursor: pointer; display: flex; align-items: center;
  justify-content: center; color: var(--color-btn-primary-text);
  transition: all var(--duration-fast) var(--ease-standard); font-size: var(--font-size-base);
}
.send-btn:hover:not(:disabled) { background-color: var(--color-primary-hover); transform: translateY(-1px); }

/* Partial Mode (Prefill) */
.partial-mode-container {
    margin-bottom: var(--space-8);
    background-color: var(--color-background);
    border: 1px solid var(--color-primary);
    border-radius: var(--radius-base);
    padding: var(--space-8);
    animation: slideDown var(--duration-fast) var(--ease-standard);
}
.partial-mode-container.hidden { display: none; }
@keyframes slideDown { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
.prefill-label {
    font-size: var(--font-size-xs);
    color: var(--color-primary);
    font-weight: var(--font-weight-medium);
    margin-bottom: var(--space-4);
    display: block;
}
#prefillInput {
    width: 100%;
    background: transparent;
    border: none;
    outline: none;
    font-family: var(--font-family-base);
    font-size: var(--font-size-sm);
    color: var(--color-text);
    resize: none;
    min-height: 40px;
}

/* Image Preview */
.image-preview { margin-bottom: var(--space-8); border: 1px solid var(--color-border); border-radius: var(--radius-base); padding: var(--space-8); background-color: var(--color-background); display: inline-block; }
.image-preview.hidden { display: none; }
.preview-container { position: relative; display: inline-block; }
.preview-image { max-height: 100px; border-radius: var(--radius-sm); border: 1px solid var(--color-border); }
.remove-image-btn {
  position: absolute; top: -8px; right: -8px;
  width: 20px; height: 20px; border-radius: 50%;
  background-color: var(--color-error); color: white;
  border: 1px solid white; cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  font-size: 14px; line-height: 1;
}

/* Popups */
.popup {
  position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
  background-color: rgba(0, 0, 0, 0.5); display: flex; align-items: center;
  justify-content: center; z-index: 1000; transition: opacity var(--duration-normal) var(--ease-standard);
}
.popup.hidden { display: none; }
.popup-content {
  background-color: var(--color-surface); border-radius: var(--radius-lg); padding: var(--space-20);
  min-width: 200px; max-width: 400px; max-height: 80vh; overflow-y: auto;
  border: 1px solid var(--color-border); box-shadow: var(--shadow-lg);
  animation: popupSlide var(--duration-normal) var(--ease-standard);
}
@keyframes popupSlide { from { transform: translateY(-10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

/* Token Corner - MILD Style */
.token-usage-corner {
  position: absolute; top: var(--space-12); right: var(--space-16);
  font-size: 10px; color: var(--color-text-secondary);
  background-color: transparent; padding: 0;
  border: none; font-family: var(--font-family-mono);
  font-weight: var(--font-weight-medium); opacity: 0.5; z-index: 2;
  cursor: help;
}
.token-usage-corner:hover { opacity: 1; }

/* Theme/Persona/Model Options */
.theme-options, .persona-options, .model-options { display: flex; flex-direction: column; gap: var(--space-8); }
.theme-option, .persona-option, .model-option {
  padding: var(--space-8) var(--space-12); border: 1px solid var(--color-border);
  background-color: var(--color-secondary); border-radius: var(--radius-base);
  cursor: pointer; text-align: left; font-size: var(--font-size-sm); color: var(--color-text);
  display: flex; align-items: center; gap: var(--space-8); justify-content: space-between;
}
.model-info { display: flex; align-items: center; gap: var(--space-8); }
.cap-badges { display: flex; gap: 4px; }
.cap-badge { font-size: 12px; opacity: 0.8; }

.theme-option.active, .persona-option.active, .model-option.active {
  background-color: var(--color-primary); color: var(--color-btn-primary-text); border-color: var(--color-primary);
}

/* History List */
.history-list {
    display: flex;
    flex-direction: column;
    gap: var(--space-8);
    margin-top: var(--space-16);
    max-height: 300px;
    overflow-y: auto;
}
.history-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-8);
    background-color: var(--color-background);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
    font-size: var(--font-size-sm);
}
.history-name { flex: 1; margin-right: var(--space-8); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.history-actions { display: flex; gap: var(--space-4); }

/* Status Indicator */
.status-container { position: fixed; top: var(--space-16); right: var(--space-16); z-index: 1001; }
.status {
  display: inline-flex; align-items: center; padding: var(--space-6) var(--space-12);
  border-radius: var(--radius-full); font-size: var(--font-size-sm); font-weight: var(--font-weight-medium);
  transition: all var(--duration-normal) var(--ease-standard);
}
.status.hidden { display: none; }
.status.show { display: inline-flex !important; }
.status--success { background-color: rgba(var(--color-success-rgb), 0.15); color: var(--color-success); border: 1px solid rgba(var(--color-success-rgb), 0.25); }
.status--error { background-color: rgba(var(--color-error-rgb), 0.15); color: var(--color-error); border: 1px solid rgba(var(--color-error-rgb), 0.25); }
.status--info { background-color: rgba(var(--color-info-rgb), 0.15); color: var(--color-info); border: 1px solid rgba(var(--color-info-rgb), 0.25); }

/* Selection Tooltip */
.selection-tooltip {
    position: absolute;
    background-color: var(--color-surface);
    border: 1px solid var(--color-primary);
    box-shadow: var(--shadow-md);
    border-radius: var(--radius-sm);
    padding: var(--space-4) var(--space-8);
    z-index: 1000;
    cursor: pointer;
    font-size: var(--font-size-xs);
    font-weight: var(--font-weight-medium);
    color: var(--color-primary);
    display: flex;
    align-items: center;
    gap: var(--space-4);
    animation: popupSlide var(--duration-fast) var(--ease-standard);
}
.selection-tooltip:hover {
    background-color: var(--color-secondary);
}
.selection-tooltip.hidden { display: none; }

/* Mobile */
@media (max-width: 768px) {
  .sidebar { width: 45px; }
  .main-content { margin-left: 45px; width: calc(100vw - 45px); }
  .popup-content { max-width: calc(100vw - 32px); margin: 16px; }
}
    </style>
<link rel="stylesheet" href="/index.css">
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-icon" id="themeToggle" title="Theme">
                <span class="icon">‚òÄÔ∏è</span>
            </div>
            <div class="sidebar-icon" id="personaToggle" title="Persona">
                <span class="icon">üë§</span>
            </div>
            <div class="sidebar-icon" id="oneShotToggle" title="One-shot Mode (Clear history on each new message)">
                <span class="icon">üî•</span>
            </div>
            <div class="sidebar-icon" id="feedbackToggle" title="Feedback Loop (Learn from edits)">
                <span class="icon">üîÅ</span>
            </div>
            <div class="sidebar-icon" id="historyToggle" title="Chat History">
                <span class="icon">üìÇ</span>
            </div>
            <div class="sidebar-icon" id="clearHistory" title="Clear Current Chat">
                <span class="icon">üóëÔ∏è</span>
            </div>
            <div class="sidebar-icon" id="apiKeyToggle" title="API Keys">
                <span class="icon">üîë</span>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Header -->
            <div class="header" id="header">
                <div class="header-info">
                    <h1>Multi-API Chat Interface</h1>
                    <div class="status-line">
                        <span class="status-item" id="modelStatus">Model: Sonar</span>
                        <span class="status-divider"> | </span>
                        <span class="status-item" id="personaStatus">Persona: All-rounder</span>
                    </div>
                </div>
                <button class="collapse-btn" id="collapseHeader">
                    <span>‚àí</span>
                </button>
            </div>

            <!-- Chat Container -->
            <div class="chat-container" id="chatContainer">
                <div class="messages-wrapper">
                    <div class="messages" id="messages">
                        <!-- Messages will be dynamically added here -->
                    </div>
                </div>
            </div>

            <!-- Input Area with Image Preview -->
            <div class="input-area">
                <!-- Image Preview Container (will be added dynamically) -->
                <div id="imagePreview" class="image-preview hidden"></div>
                <!-- Partial Mode Input -->
                <div id="partialModeContainer" class="partial-mode-container hidden">
                    <span class="prefill-label">Partial / Prefill Mode (Assistant Start):</span>
                    <textarea id="prefillInput" placeholder="Type the beginning of the assistant's response here (e.g., 'Sure, here is the list:')..."></textarea>
                </div>
                <div class="input-wrapper">
                    <textarea 
                        id="messageInput" 
                        placeholder="Type your message here..."
                        rows="1"></textarea>
                    <div class="input-actions">
                        <button class="action-btn hidden" id="togglePartialMode" title="Partial / Prefill Mode (Kimi/Moonshot)">
                            <span>üìù</span>
                        </button>
                        <button class="action-btn" id="manualImageInput" title="Input Image URL/Base64">
                            <span>üì•</span>
                        </button>
                        <button class="action-btn" id="imageUpload" title="Upload Image">
                            <span>üì∑</span>
                        </button>
                        <button class="action-btn" id="modelToggle" title="Change Model & Settings">
                            <span>‚öôÔ∏è</span>
                        </button>
                        <button class="send-btn" id="sendMessage" title="Send Message">
                            <span>‚Üí</span>
                        </button>
                    </div>
                </div>
                <input type="file" id="fileInput" accept="image/*" style="display: none;">
            </div>
        </div>
    </div>

    <!-- Status Indicator -->
    <div class="status-container">
        <div class="status hidden" id="statusIndicator"></div>
    </div>

    <!-- Selection Tooltip -->
    <button class="selection-tooltip hidden" id="selectionTooltip">
        <span>‚úèÔ∏è</span> Improve
    </button>

    <!-- Theme Popup -->
    <div class="popup hidden" id="themePopup">
        <div class="popup-content">
            <h3>Choose Theme</h3>
            <div class="theme-options">
                <button class="theme-option" data-theme="light">
                    <span>‚òÄÔ∏è</span> Light Theme
                </button>
                <button class="theme-option" data-theme="dark">
                    <span>üåô</span> Dark Theme  
                </button>
            </div>
        </div>
    </div>

    <!-- Persona Popup -->
    <div class="popup hidden" id="personaPopup">
        <div class="popup-content">
            <h3>Choose Persona</h3>
            <div class="persona-options">
                <button class="persona-option" data-persona="allrounder">
                    <span>üéØ</span> All-rounder
                </button>
                <button class="persona-option" data-persona="grammar">
                    <span>üìù</span> Grammar checker
                </button>
                <button class="persona-option" data-persona="auditor">
                    <span>üîç</span> Auditor
                </button>
                <button class="persona-option" data-persona="customized">
                    <span>‚öôÔ∏è</span> Customized
                </button>
            </div>
            <div class="custom-prompt-section hidden" id="customPromptSection">
                <label class="form-label">Custom Prompt:</label>
                <textarea id="customPrompt" class="form-control" placeholder="Enter your custom prompt here..." rows="3"></textarea>
                <div class="form-group" style="margin-top: 8px;">
                    <button class="btn btn--primary btn--sm" id="saveCustomPrompt">Save Custom Prompt</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Model Popup -->
    <div class="popup hidden" id="modelPopup">
        <div class="popup-content">
            <h3>Choose Model & Settings</h3>
            
            <div class="form-group">
                <label class="form-label">Max Tokens: <span id="maxTokensValue">4096</span></label>
                <input type="range" id="maxTokensSlider" min="100" max="8000" step="100" value="4096">
                <input type="number" id="maxTokensInput" class="form-control" style="width: 100%; margin-top: 4px;" value="4096" min="100" max="8000">
            </div>

            <h4 style="margin-top:16px;">Perplexity Models</h4>
            <div class="model-options">
                <button class="model-option" data-model="sonar" data-api="perplexity">
                    <div class="model-info"><span>üîç</span> Sonar</div>
                </button>
                <button class="model-option" data-model="sonar-pro" data-api="perplexity">
                    <div class="model-info"><span>üîç</span> Sonar Pro</div>
                    <div class="cap-badges"><span class="cap-badge" title="Vision Capable">üëÅÔ∏è</span></div>
                </button>
                <button class="model-option" data-model="sonar-reasoning-pro" data-api="perplexity">
                    <div class="model-info"><span>üß†</span> Sonar Reasoning Pro</div>
                    <div class="cap-badges"><span class="cap-badge" title="Reasoning">üß†</span></div>
                </button>
                <button class="model-option" data-model="sonar-deep-research" data-api="perplexity">
                    <div class="model-info"><span>üìö</span> Sonar Deep Research</div>
                    <div class="cap-badges"><span class="cap-badge" title="Reasoning">üß†</span></div>
                </button>
            </div>
            <h4 style="margin-top: 16px;">Moonshot Models (Kimi)</h4>
            <div class="model-options">
                <button class="model-option" data-model="kimi-k2-0905-preview" data-api="moonshot">
                    <div class="model-info"><span>üöÄ</span> Kimi k2 (Preview)</div>
                    <div class="cap-badges"><span class="cap-badge" title="Vision Capable">üëÅÔ∏è</span></div>
                </button>
                <button class="model-option" data-model="kimi-k2-turbo-preview" data-api="moonshot">
                    <div class="model-info"><span>üöÄ</span> Kimi k2 Turbo (Preview)</div>
                    <div class="cap-badges"><span class="cap-badge" title="Vision Capable">üëÅÔ∏è</span></div>
                </button>
                <button class="model-option" data-model="kimi-k2-thinking" data-api="moonshot">
                    <div class="model-info"><span>üß†</span> Kimi k2 Thinking</div>
                    <div class="cap-badges"><span class="cap-badge" title="Reasoning">üß†</span> <span class="cap-badge" title="Vision Capable">üëÅÔ∏è</span></div>
                </button>
                <button class="model-option" data-model="kimi-k2-thinking-turbo" data-api="moonshot">
                    <div class="model-info"><span>üß†</span> Kimi k2 Thinking Turbo</div>
                    <div class="cap-badges"><span class="cap-badge" title="Reasoning">üß†</span> <span class="cap-badge" title="Vision Capable">üëÅÔ∏è</span></div>
                </button>
                <button class="model-option" data-model="moonshot-k1" data-api="moonshot">
                    <div class="model-info"><span>üß†</span> Kimi k1 (Reasoning)</div>
                    <div class="cap-badges"><span class="cap-badge" title="Reasoning">üß†</span></div>
                </button>
                <button class="model-option" data-model="moonshot-v1-8k" data-api="moonshot">
                    <div class="model-info"><span>üåô</span> Kimi v1 8K</div>
                </button>
                <button class="model-option" data-model="moonshot-v1-32k" data-api="moonshot">
                    <div class="model-info"><span>üåô</span> Kimi v1 32K</div>
                </button>
                <button class="model-option" data-model="moonshot-v1-128k" data-api="moonshot">
                    <div class="model-info"><span>üåô</span> Kimi v1 128K</div>
                </button>
            </div>
            <div style="margin-top: 12px; font-size: 11px; color: var(--color-text-secondary); text-align: center;">
                Icons: üëÅÔ∏è Vision Capable | üß† Thinking/Reasoning
            </div>
        </div>
    </div>

    <!-- API Key Popup -->
    <div class="popup hidden" id="apiKeyPopup">
        <div class="popup-content">
            <h3>API Keys</h3>
            <div class="api-section">
                <h4>Perplexity API</h4>
                <div class="form-group">
                    <label class="form-label">API Key:</label>
                    <input type="password" id="perplexityApiKey" class="form-control" placeholder="Enter Perplexity API key">
                </div>
            </div>
            <div class="api-section">
                <h4>Moonshot API</h4>
                <div class="form-group">
                    <label class="form-label">API Key:</label>
                    <input type="password" id="moonshotApiKey" class="form-control" placeholder="Enter Moonshot API key">
                </div>
            </div>
            <div class="form-group">
                <button class="btn btn--secondary btn--sm" id="showApiKeys">Show/Hide</button>
                <button class="btn btn--primary btn--sm" id="saveApiKeys">Save Keys</button>
            </div>
        </div>
    </div>

    <!-- Reference Popup -->
    <div class="popup hidden" id="referencePopup">
        <div class="popup-content reference-popup-content">
            <div class="reference-header">
                <h3 id="referenceTitle">Reference</h3>
                <button class="close-btn" id="closeReferencePopup" style="background:none; border:none; font-size:20px; cursor:pointer;">&times;</button>
            </div>
            <div class="reference-body">
                <p id="referenceUrl"></p>
            </div>
            <div class="reference-actions">
                <button class="btn btn--secondary btn--sm" id="copyReference">Copy URL</button>
                <button class="btn btn--primary btn--sm" id="openReference">Open Link</button>
            </div>
        </div>
    </div>

    <!-- Manual Image Input Popup -->
    <div class="popup hidden" id="imageInputPopup">
        <div class="popup-content" style="max-width: 500px;">
            <h3>Set Image Source</h3>
            <div class="form-group">
                <label class="form-label">Image URL or Base64 String:</label>
                <textarea id="imageInputString" class="form-control" rows="5" placeholder="Paste URL or Base64 string here..."></textarea>
                <p style="font-size: 11px; color: var(--color-text-secondary); margin-top: 4px;">
                    Tip: For raw Base64, we'll automatically add the data:image prefix for you.
                </p>
            </div>
            <div class="form-group">
                <button class="btn btn--secondary btn--sm" id="cancelImageInput">Cancel</button>
                <button class="btn btn--primary btn--sm" id="saveImageInput">Set Image</button>
            </div>
        </div>
    </div>

    <!-- History Popup -->
    <div class="popup hidden" id="historyPopup">
        <div class="popup-content">
            <h3>Chat History</h3>
            <div class="form-group">
                <label class="form-label">Save Current Chat:</label>
                <div style="display: flex; gap: 8px;">
                    <input type="text" id="chatNameInput" class="form-control" placeholder="Chat Name">
                    <button class="btn btn--primary btn--sm" id="saveChatBtn">Save</button>
                </div>
            </div>
            <h4>Saved Chats</h4>
            <div class="history-list" id="historyList">
                <!-- History items will be here -->
                <p style="text-align:center; color: var(--color-text-secondary);">No saved chats.</p>
            </div>
        </div>
    </div>

    <!-- Revision Popup -->
    <div class="popup hidden" id="revisionPopup">
        <div class="popup-content" style="max-width: 600px;">
            <h3>Feedback Loop</h3>
            <p style="font-size: var(--font-size-sm); color: var(--color-text-secondary); margin-bottom: 16px;">
                Provide the revised version. The model will learn from this in future messages within this chat.
            </p>
            <div class="form-group">
                <label class="form-label">Original:</label>
                <div id="revisionOriginal" style="background: var(--color-secondary); padding: 8px; border-radius: 6px; font-size: var(--font-size-sm); max-height: 150px; overflow-y: auto;"></div>
            </div>
            <div class="form-group">
                <label class="form-label">Revised:</label>
                <textarea id="revisionInput" class="form-control" rows="5" placeholder="Enter how it should have been written..."></textarea>
            </div>
            <div class="form-group">
                <button class="btn btn--secondary btn--sm" id="cancelRevision">Cancel</button>
                <button class="btn btn--primary btn--sm" id="saveRevision">Save & Learn</button>
            </div>
        </div>
    </div>

    <!-- Embedded JavaScript -->
    <script>
class MultiAPIChat {
    constructor() {
        this.apiKeys = {
            perplexity: localStorage.getItem('perplexity_api_key') || '',
            moonshot: localStorage.getItem('moonshot_api_key') || ''
        };
        this.currentModel = 'sonar';
        this.currentAPI = 'perplexity';
        this.currentPersona = 'allrounder';
        this.customPrompt = '';
        this.messages = [];
        this.uploadedImage = null;
        this.isLoading = false;
        this.references = {};
        this.currentReference = { num: '', url: '' };
        this.oneShotMode = localStorage.getItem('oneShotMode') === 'true' || false;
        this.savedChats = JSON.parse(localStorage.getItem('saved_chats') || '{}');
        this.maxTokens = parseInt(localStorage.getItem('maxTokens') || '4096');
        
        // Feedloop / Feedback properties
        this.feedbackMode = localStorage.getItem('feedbackMode') === 'true' || false;
        this.feedbackLoops = JSON.parse(localStorage.getItem('feedback_loops') || '{}');
        this.currentChatId = Date.now().toString(); // Initialize a session ID immediately

        this.converter = new showdown.Converter({
            tables: true,
            strikethrough: true,
            tasklists: true,
            ghCodeBlocks: true,
            openLinksInNewWindow: true,
            emoji: true
        });

        this.personas = {
            allrounder: { name: "All-rounder", prompt: "You are a versatile AI assistant." },
            grammar: { name: "Grammar checker", prompt: "You are a professional grammar checker. Correct the text and explain." },
            auditor: { name: "Auditor", prompt: "You are an experienced audit specialist." },
            customized: { name: "Customized", prompt: "" }
        };

        this.models = {
            perplexity: [
                { value: "sonar", name: "Sonar" },
                { value: "sonar-pro", name: "Sonar Pro" },
                { value: "sonar-reasoning-pro", name: "Sonar Reasoning Pro" },
                { value: "sonar-deep-research", name: "Sonar Deep Research" }
            ],
            moonshot: [
                { value: "kimi-k2-0905-preview", name: "Kimi k2 (Preview)" },
                { value: "kimi-k2-turbo-preview", name: "Kimi k2 Turbo (Preview)" },
                { value: "kimi-k2-thinking", name: "Kimi k2 Thinking" },
                { value: "kimi-k2-thinking-turbo", name: "Kimi k2 Thinking Turbo" },
                { value: "moonshot-k1", name: "Kimi k1 (Reasoning)" },
                { value: "moonshot-v1-8k", name: "Kimi v1 8K" },
                { value: "moonshot-v1-32k", name: "Kimi v1 32K" },
                { value: "moonshot-v1-128k", name: "Kimi v1 128K" }
            ]
        };

        this.apiEndpoints = {
            perplexity: "https://api.perplexity.ai/chat/completions",
            moonshot: "https://api.moonshot.cn/v1/chat/completions"
        };

        this.initializeElements();
        this.attachEventListeners();
        this.loadTheme();
        this.loadSettings();
        this.updateUI();
        this.updateHeaderStatus();
        this.updateOneShotButton();
        this.updateFeedbackButton();
        this.updateTokenConfigUI();
        this.updatePartialModeButton(); // Initial check
    }

    initializeElements() {
        this.themeToggle = document.getElementById('themeToggle');
        this.personaToggle = document.getElementById('personaToggle');
        this.clearHistory = document.getElementById('clearHistory');
        this.apiKeyToggle = document.getElementById('apiKeyToggle');
        this.oneShotToggle = document.getElementById('oneShotToggle');
        this.feedbackToggle = document.getElementById('feedbackToggle');
        this.historyToggle = document.getElementById('historyToggle');

        this.header = document.getElementById('header');
        this.collapseHeader = document.getElementById('collapseHeader');
        this.chatContainer = document.getElementById('chatContainer');
        this.messagesContainer = document.getElementById('messages');
        this.modelStatus = document.getElementById('modelStatus');
        this.personaStatus = document.getElementById('personaStatus');

        this.messageInput = document.getElementById('messageInput');
        this.sendMessage = document.getElementById('sendMessage');
        this.imageUpload = document.getElementById('imageUpload');
        this.fileInput = document.getElementById('fileInput');
        this.modelToggle = document.getElementById('modelToggle');

        // Partial Mode
        this.togglePartialModeBtn = document.getElementById('togglePartialMode');
        this.partialModeContainer = document.getElementById('partialModeContainer');
        this.prefillInput = document.getElementById('prefillInput');

        // Image Input Elements
        this.manualImageInput = document.getElementById('manualImageInput');
        this.imageInputPopup = document.getElementById('imageInputPopup');
        this.imageInputString = document.getElementById('imageInputString');
        this.saveImageInputBtn = document.getElementById('saveImageInput');
        this.cancelImageInputBtn = document.getElementById('cancelImageInput');

        this.imagePreview = document.getElementById('imagePreview');

        this.themePopup = document.getElementById('themePopup');
        this.personaPopup = document.getElementById('personaPopup');
        this.modelPopup = document.getElementById('modelPopup');
        this.apiKeyPopup = document.getElementById('apiKeyPopup');
        this.referencePopup = document.getElementById('referencePopup');
        this.historyPopup = document.getElementById('historyPopup');
        
        // Revision Elements
        this.revisionPopup = document.getElementById('revisionPopup');
        this.selectionTooltip = document.getElementById('selectionTooltip');
        this.revisionOriginal = document.getElementById('revisionOriginal');
        this.revisionInput = document.getElementById('revisionInput');
        this.cancelRevisionBtn = document.getElementById('cancelRevision');
        this.saveRevisionBtn = document.getElementById('saveRevision');

        this.statusIndicator = document.getElementById('statusIndicator');

        // History Elements
        this.chatNameInput = document.getElementById('chatNameInput');
        this.saveChatBtn = document.getElementById('saveChatBtn');
        this.historyList = document.getElementById('historyList');

        // Token Elements
        this.maxTokensSlider = document.getElementById('maxTokensSlider');
        this.maxTokensInput = document.getElementById('maxTokensInput');
        this.maxTokensValue = document.getElementById('maxTokensValue');
    }

    attachEventListeners() {
        this.themeToggle.addEventListener('click', () => this.togglePopup('theme'));
        this.personaToggle.addEventListener('click', () => this.togglePopup('persona'));
        this.clearHistory.addEventListener('click', () => this.clearChatHistory());
        this.apiKeyToggle.addEventListener('click', () => this.togglePopup('apiKey'));
        this.oneShotToggle.addEventListener('click', () => this.toggleOneShotMode());
        this.feedbackToggle.addEventListener('click', () => this.toggleFeedbackMode());
        this.historyToggle.addEventListener('click', () => {
            this.renderChatHistory();
            this.togglePopup('history');
        });
        this.collapseHeader.addEventListener('click', () => this.toggleHeader());

        this.messageInput.addEventListener('input', () => {
            this.autoResizeTextarea();
        });
        this.messageInput.addEventListener('keydown', (e) => this.handleKeyDown(e));
        this.sendMessage.addEventListener('click', () => this.sendUserMessage());
        
        // Partial Mode
        this.togglePartialModeBtn.addEventListener('click', () => {
            this.partialModeContainer.classList.toggle('hidden');
            if(!this.partialModeContainer.classList.contains('hidden')) {
                this.prefillInput.focus();
            }
        });

        // Image Handling
        this.imageUpload.addEventListener('click', () => this.fileInput.click());
        this.fileInput.addEventListener('change', (e) => this.handleFileUpload(e));
        this.manualImageInput.addEventListener('click', () => this.togglePopup('imageInput'));
        this.saveImageInputBtn.addEventListener('click', () => this.saveImageInput());
        this.cancelImageInputBtn.addEventListener('click', () => this.togglePopup('imageInput'));

        this.modelToggle.addEventListener('click', () => this.togglePopup('model'));

        document.querySelectorAll('.theme-option').forEach(btn => {
            btn.addEventListener('click', (e) => this.setTheme(e.target.dataset.theme));
        });
        document.querySelectorAll('.persona-option').forEach(btn => {
            btn.addEventListener('click', (e) => this.setPersona(e.target.dataset.persona));
        });
        document.querySelectorAll('.model-option').forEach(btn => {
            btn.addEventListener('click', (e) => {
                this.setModel(e.target.dataset.model, e.target.dataset.api);
            });
        });

        document.getElementById('saveApiKeys').addEventListener('click', () => this.saveApiKeys());
        document.getElementById('showApiKeys').addEventListener('click', () => this.toggleApiKeysVisibility());
        document.getElementById('saveCustomPrompt').addEventListener('click', () => this.saveCustomPrompt());
        
        // History Actions
        this.saveChatBtn.addEventListener('click', () => this.saveCurrentChat());

        // Token Slider Sync
        this.maxTokensSlider.addEventListener('input', (e) => this.updateMaxTokens(e.target.value));
        this.maxTokensInput.addEventListener('input', (e) => this.updateMaxTokens(e.target.value));

        document.getElementById('closeReferencePopup').addEventListener('click', () => this.closeReferencePopup());
        document.getElementById('openReference').addEventListener('click', () => this.openReference());
        document.getElementById('copyReference').addEventListener('click', () => this.copyReference());
        
        // Feedloop / Revision Actions
        document.addEventListener('mouseup', (e) => this.handleTextSelection(e));
        this.selectionTooltip.addEventListener('click', () => this.openRevisionPopup());
        this.cancelRevisionBtn.addEventListener('click', () => this.closeRevisionPopup());
        this.saveRevisionBtn.addEventListener('click', () => this.saveRevision());

        document.addEventListener('click', (e) => this.handleOutsideClick(e));
        document.querySelectorAll('.popup-content').forEach(content => {
            content.addEventListener('click', (e) => e.stopPropagation());
        });
    }

    togglePopup(type) {
        const popups = ['theme', 'persona', 'model', 'apiKey', 'imageInput', 'history', 'revision'];
        popups.forEach(popupType => {
            if (popupType !== type) {
                const popup = document.getElementById(`${popupType}Popup`);
                if (popup) popup.classList.add('hidden');
            }
        });

        const popup = document.getElementById(`${type}Popup`);
        if (popup) {
            popup.classList.toggle('hidden');
            if (type === 'persona') {
                const customSection = document.getElementById('customPromptSection');
                if (this.currentPersona === 'customized') {
                    customSection.classList.remove('hidden');
                    document.getElementById('customPrompt').value = this.customPrompt;
                } else {
                    customSection.classList.add('hidden');
                }
            }
            if (type === 'apiKey') {
                document.getElementById('perplexityApiKey').value = this.apiKeys.perplexity;
                document.getElementById('moonshotApiKey').value = this.apiKeys.moonshot;
            }
        }
    }
    
    // Feedback Loop Logic
    toggleFeedbackMode() {
        this.feedbackMode = !this.feedbackMode;
        localStorage.setItem('feedbackMode', this.feedbackMode);
        this.updateFeedbackButton();
        this.showStatus(this.feedbackMode ? 'Feedback Loop Enabled (Select text to revise)' : 'Feedback Loop Disabled', this.feedbackMode ? 'success' : 'info');
    }

    updateFeedbackButton() {
        if(this.feedbackToggle) {
            this.feedbackToggle.classList.toggle('active', this.feedbackMode);
        }
    }

    handleTextSelection(e) {
        if (!this.feedbackMode) return;
        
        // Hide tooltip if clicking elsewhere or empty selection
        const selection = window.getSelection();
        if (!selection || selection.toString().trim() === '') {
            this.selectionTooltip.classList.add('hidden');
            return;
        }

        // Only allow selection inside messages
        if (!this.messagesContainer.contains(selection.anchorNode)) {
             this.selectionTooltip.classList.add('hidden');
             return;
        }

        // Show tooltip
        const range = selection.getRangeAt(0);
        const rect = range.getBoundingClientRect();
        
        this.selectionTooltip.style.top = `${rect.top + window.scrollY - 40}px`;
        this.selectionTooltip.style.left = `${rect.left + window.scrollX}px`;
        this.selectionTooltip.classList.remove('hidden');
    }

    openRevisionPopup() {
        const selection = window.getSelection();
        if (!selection) return;
        
        this.currentSelectionText = selection.toString();
        this.revisionOriginal.textContent = this.currentSelectionText;
        this.revisionInput.value = '';
        this.selectionTooltip.classList.add('hidden');
        this.togglePopup('revision');
    }

    closeRevisionPopup() {
        this.revisionPopup.classList.add('hidden');
    }

    saveRevision() {
        const revised = this.revisionInput.value.trim();
        if (!revised) {
            this.showStatus('Please enter a revised version', 'warning');
            return;
        }

        // Initialize array for this chat ID if not exists
        if (!this.feedbackLoops[this.currentChatId]) {
            this.feedbackLoops[this.currentChatId] = [];
        }

        this.feedbackLoops[this.currentChatId].push({
            original: this.currentSelectionText,
            revised: revised
        });

        localStorage.setItem('feedback_loops', JSON.stringify(this.feedbackLoops));
        this.closeRevisionPopup();
        this.showStatus('Feedback learned!', 'success');
    }

    // Max Tokens Logic
    updateMaxTokens(value) {
        const val = parseInt(value);
        if (isNaN(val)) return;
        this.maxTokens = val;
        this.maxTokensSlider.value = val;
        this.maxTokensInput.value = val;
        this.maxTokensValue.textContent = val;
        localStorage.setItem('maxTokens', val);
    }
    
    updateTokenConfigUI() {
        this.maxTokensSlider.value = this.maxTokens;
        this.maxTokensInput.value = this.maxTokens;
        this.maxTokensValue.textContent = this.maxTokens;
    }

    // History Logic
    saveCurrentChat() {
        const name = this.chatNameInput.value.trim();
        if (!name) {
            this.showStatus('Please enter a chat name', 'warning');
            return;
        }
        if (this.messages.length === 0) {
            this.showStatus('No messages to save', 'warning');
            return;
        }
        
        // Use the current session ID
        const id = this.currentChatId;
        
        this.savedChats[id] = {
            id: id,
            name: name,
            date: new Date().toISOString(),
            messages: this.messages,
            references: this.references
        };
        localStorage.setItem('saved_chats', JSON.stringify(this.savedChats));
        this.chatNameInput.value = '';
        this.renderChatHistory();
        this.showStatus('Chat saved', 'success');
    }

    deleteChat(id) {
        if (confirm('Delete this chat and its learned feedback?')) {
            delete this.savedChats[id];
            localStorage.setItem('saved_chats', JSON.stringify(this.savedChats));
            
            // Clean up feedback loops associated with this chat
            if (this.feedbackLoops[id]) {
                delete this.feedbackLoops[id];
                localStorage.setItem('feedback_loops', JSON.stringify(this.feedbackLoops));
            }

            this.renderChatHistory();
        }
    }

    loadChat(id) {
        const chat = this.savedChats[id];
        if (chat) {
            this.currentChatId = id; // Set active chat ID to the loaded one
            this.messages = chat.messages || [];
            this.references = chat.references || {};
            this.renderMessages();
            this.showStatus(`Loaded "${chat.name}"`, 'success');
            this.togglePopup('history');
        }
    }

    renderChatHistory() {
        this.historyList.innerHTML = '';
        const ids = Object.keys(this.savedChats).sort((a, b) => b - a); // Newest first
        if (ids.length === 0) {
            this.historyList.innerHTML = '<p style="text-align:center; color: var(--color-text-secondary);">No saved chats.</p>';
            return;
        }

        ids.forEach(id => {
            const chat = this.savedChats[id];
            const item = document.createElement('div');
            item.className = 'history-item';
            
            const nameSpan = document.createElement('span');
            nameSpan.className = 'history-name';
            nameSpan.textContent = chat.name;
            item.appendChild(nameSpan);

            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'history-actions';

            const loadBtn = document.createElement('button');
            loadBtn.className = 'btn btn--primary btn--sm';
            loadBtn.textContent = 'Load';
            loadBtn.onclick = () => this.loadChat(id);

            const delBtn = document.createElement('button');
            delBtn.className = 'btn btn--secondary btn--sm';
            delBtn.innerHTML = 'üóëÔ∏è';
            delBtn.onclick = () => this.deleteChat(id);

            actionsDiv.appendChild(loadBtn);
            actionsDiv.appendChild(delBtn);
            item.appendChild(actionsDiv);
            
            this.historyList.appendChild(item);
        });
    }

    // Logic to save image from popup
    saveImageInput() {
        let input = this.imageInputString.value.trim();
        if (input) {
            const isRawBase64 = /^[A-Za-z0-9+/=]+$/.test(input) && input.length > 50;
            if (isRawBase64) {
                input = `data:image/png;base64,${input}`;
            }

            if (input.startsWith('http') || input.startsWith('data:image')) {
                this.uploadedImage = input;
                this.showImagePreview(input);
                this.showStatus('Image source set', 'success');
                this.togglePopup('imageInput');
                this.imageInputString.value = '';
                this.ensureVisionModel();
            } else {
                this.showStatus('Invalid format. Must be URL or Base64', 'error');
            }
        } else {
            this.showStatus('Please enter a URL or Base64 string', 'warning');
        }
    }

    handleFileUpload(e) {
        const file = e.target.files[0];
        if (file && file.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onload = (e) => {
                this.uploadedImage = e.target.result;
                this.showImagePreview(e.target.result);
                this.showStatus('Image uploaded successfully', 'success');
                this.ensureVisionModel();
            };
            reader.readAsDataURL(file);
        } else if (file) {
            this.showStatus('Please select an image file', 'error');
        }
    }

    ensureVisionModel() {
        const visionModels = [
            'sonar-pro',
            'kimi-k2-0905-preview',
            'kimi-k2-turbo-preview',
            'kimi-k2-thinking',
            'kimi-k2-thinking-turbo'
        ];
        
        // If current model is NOT capable of vision, switch to Sonar Pro
        if (!visionModels.includes(this.currentModel)) {
            this.setModel('sonar-pro', 'perplexity');
            this.showStatus('Switched to Sonar Pro for image analysis', 'info');
        }
    }

    showImagePreview(imageSrc) {
        if (!this.imagePreview) {
            this.imagePreview = document.createElement('div');
            this.imagePreview.id = 'imagePreview';
            this.imagePreview.className = 'image-preview';
            const inputArea = document.querySelector('.input-area');
            inputArea.insertBefore(this.imagePreview, inputArea.firstChild);
        }
        this.imagePreview.innerHTML = `
            <div class="preview-container">
                <img src="${imageSrc}" alt="Image preview" class="preview-image">
                <button class="remove-image-btn" onclick="window.chatApp.removeImagePreview()" title="Remove image">√ó</button>
            </div>
        `;
        this.imagePreview.classList.remove('hidden');
    }

    removeImagePreview() {
        if (this.imagePreview) {
            this.imagePreview.classList.add('hidden');
            this.imagePreview.innerHTML = '';
        }
        this.uploadedImage = null;
        this.fileInput.value = '';
    }

    handleOutsideClick(e) {
        if (e.target.classList.contains('popup')) {
            e.target.classList.add('hidden');
        }
    }

    toggleOneShotMode() {
        this.oneShotMode = !this.oneShotMode;
        localStorage.setItem('oneShotMode', this.oneShotMode.toString());
        this.updateOneShotButton();
        this.showStatus(this.oneShotMode ? 'One-shot mode enabled' : 'One-shot mode disabled', this.oneShotMode ? 'success' : 'info');
    }

    updateOneShotButton() {
        if (this.oneShotToggle) {
            this.oneShotToggle.classList.toggle('active', this.oneShotMode);
        }
    }

    updateHeaderStatus() {
        const modelName = this.getModelDisplayName();
        const personaName = this.personas[this.currentPersona]?.name || 'Unknown';
        this.modelStatus.textContent = `Model: ${modelName}`;
        this.personaStatus.textContent = `Persona: ${personaName}`;
    }

    getModelDisplayName() {
        const apiModels = this.models[this.currentAPI];
        const model = apiModels?.find(m => m.value === this.currentModel);
        return model ? model.name : this.currentModel;
    }

    toggleHeader() {
        this.header.classList.toggle('collapsed');
        const btn = this.collapseHeader.querySelector('span');
        btn.textContent = this.header.classList.contains('collapsed') ? '+' : '‚àí';
    }

    autoResizeTextarea() {
        this.messageInput.style.height = 'auto';
        this.messageInput.style.height = Math.min(this.messageInput.scrollHeight, 120) + 'px';
    }

    resetTextareaSize() {
        this.messageInput.style.height = 'auto';
        this.messageInput.rows = 1;
    }

    handleKeyDown(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            this.sendUserMessage();
        }
    }

    setTheme(theme) {
        document.documentElement.setAttribute('data-color-scheme', theme);
        localStorage.setItem('theme', theme);
        this.updateThemeIcon(theme);
        this.togglePopup('theme');
        this.updateThemeOptions();
    }

    updateThemeIcon(theme) {
        const icon = this.themeToggle.querySelector('.icon');
        icon.textContent = theme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
    }

    updateThemeOptions() {
        const currentTheme = document.documentElement.getAttribute('data-color-scheme') || 'light';
        document.querySelectorAll('.theme-option').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.theme === currentTheme);
        });
    }

    setPersona(persona) {
        this.currentPersona = persona;
        localStorage.setItem('currentPersona', persona);
        this.updatePersonaOptions();
        this.updateHeaderStatus();
        if (persona === 'customized') {
            const customSection = document.getElementById('customPromptSection');
            customSection.classList.remove('hidden');
        } else {
            this.togglePopup('persona');
        }
    }

    updatePersonaOptions() {
        document.querySelectorAll('.persona-option').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.persona === this.currentPersona);
        });
    }

    setModel(model, api) {
        this.currentModel = model;
        this.currentAPI = api;
        localStorage.setItem('currentModel', model);
        localStorage.setItem('currentAPI', api);
        this.updateModelOptions();
        this.updateHeaderStatus();
        this.updatePartialModeButton(); // Update partial mode button visibility
        this.togglePopup('model');
    }

    updatePartialModeButton() {
        if (this.currentAPI === 'moonshot') {
            this.togglePartialModeBtn.classList.remove('hidden');
        } else {
            this.togglePartialModeBtn.classList.add('hidden');
            this.partialModeContainer.classList.add('hidden');
        }
    }

    updateModelOptions() {
        document.querySelectorAll('.model-option').forEach(btn => {
            const isActive = btn.dataset.model === this.currentModel && btn.dataset.api === this.currentAPI;
            btn.classList.toggle('active', isActive);
        });
    }

    saveCustomPrompt() {
        this.customPrompt = document.getElementById('customPrompt').value;
        localStorage.setItem('customPrompt', this.customPrompt);
        this.togglePopup('persona');
        this.showStatus('Custom prompt saved', 'success');
    }

    saveApiKeys() {
        this.apiKeys.perplexity = document.getElementById('perplexityApiKey').value.trim();
        this.apiKeys.moonshot = document.getElementById('moonshotApiKey').value.trim();
        localStorage.setItem('perplexity_api_key', this.apiKeys.perplexity);
        localStorage.setItem('moonshot_api_key', this.apiKeys.moonshot);
        this.togglePopup('apiKey');
        this.showStatus('API keys saved', 'success');
    }

    toggleApiKeysVisibility() {
        const perplexityInput = document.getElementById('perplexityApiKey');
        const moonshotInput = document.getElementById('moonshotApiKey');
        if (perplexityInput.type === 'password') {
            perplexityInput.type = 'text';
            moonshotInput.type = 'text';
        } else {
            perplexityInput.type = 'password';
            moonshotInput.type = 'password';
        }
    }

    clearChatHistory() {
        if (confirm('Are you sure you want to clear the current chat messages?')) {
            this.messages = [];
            this.references = {};
            this.currentChatId = Date.now().toString(); // Generate new session ID on clear
            this.renderMessages();
            this.showStatus('Current chat cleared', 'info');
        }
    }

    loadTheme() {
        const theme = localStorage.getItem('theme') || 'light';
        document.documentElement.setAttribute('data-color-scheme', theme);
        this.updateThemeIcon(theme);
    }

    loadSettings() {
        this.currentPersona = localStorage.getItem('currentPersona') || 'allrounder';
        this.currentModel = localStorage.getItem('currentModel') || 'sonar';
        this.currentAPI = localStorage.getItem('currentAPI') || 'perplexity';
        this.customPrompt = localStorage.getItem('customPrompt') || '';
        this.apiKeys.moonshot = localStorage.getItem('moonshot_api_key') || '';
        this.oneShotMode = localStorage.getItem('oneShotMode') === 'true';
    }

    updateUI() {
        this.updateThemeOptions();
        this.updatePersonaOptions();
        this.updateModelOptions();
        this.updateOneShotButton();
    }

    async sendUserMessage() {
        const message = this.messageInput.value.trim();
        const prefill = this.prefillInput.value.trim();
        
        if (!message && !this.uploadedImage) return;
        if (this.isLoading) return;

        if (this.oneShotMode && this.messages.length > 0) {
            this.messages = [];
            this.references = {};
            this.renderMessages();
        }

        const userMessage = {
            role: 'user',
            content: message,
            image: this.uploadedImage,
            timestamp: new Date()
        };
        this.messages.push(userMessage);

        this.messageInput.value = '';
        this.prefillInput.value = ''; // Clear prefill
        this.partialModeContainer.classList.add('hidden'); // Hide partial mode after send
        
        this.resetTextareaSize();
        this.removeImagePreview();
        this.uploadedImage = null;
        this.renderMessages();

        const currentApiKey = this.apiKeys[this.currentAPI];
        if (!currentApiKey) {
            this.showStatus(`No ${this.currentAPI} API key set`, 'warning');
            return;
        }

        this.setLoading(true);

        try {
            const response = await this.callAPI(message, prefill);
            
            // If we used prefill, prepend it to the response content for display
            const finalContent = prefill ? (prefill + response.content) : response.content;
            
            const assistantMessage = {
                role: 'assistant',
                content: finalContent,
                timestamp: new Date(),
                tokenUsage: response.tokenUsage,
                searchResults: response.searchResults || [],
                citations: response.citations || []
            };
            this.messages.push(assistantMessage);
            this.renderMessages();
        } catch (error) {
            this.showStatus('Error: ' + error.message, 'error');
            const fallbackResponse = {
                role: 'assistant',
                content: "I'm sorry, I encountered an error. Please check your API key and connection.",
                timestamp: new Date(),
                tokenUsage: {}
            };
            this.messages.push(fallbackResponse);
            this.renderMessages();
        } finally {
            this.setLoading(false);
        }
    }

    buildMessagesForAPI(prefill) {
        const systemPrompt = this.getSystemPrompt();
        const apiMessages = [
            { role: 'system', content: systemPrompt }
        ];

        // Increased context window to 15
        let recentMessages = this.messages.slice(-15);

        // Ensure the conversation history starts with a USER message.
        // If the slice captures an Assistant message first, remove it to maintain strict alternation.
        while (recentMessages.length > 0 && recentMessages[0].role !== 'user') {
            recentMessages.shift();
        }

        for (const msg of recentMessages) {
            if (msg.role === 'user') {
                if (msg.image) {
                    // Vision payload for Perplexity
                    apiMessages.push({
                        role: 'user',
                        content: [
                            { type: 'text', text: msg.content || " " },
                            { type: 'image_url', image_url: { url: msg.image, detail: "auto" } }
                        ]
                    });
                } else {
                    apiMessages.push({
                        role: 'user',
                        content: msg.content
                    });
                }
            } else if (msg.role === 'assistant' && msg.content) {
                apiMessages.push({
                    role: 'assistant',
                    content: msg.content
                });
            }
        }

        // If Partial Mode (Prefill) is active, append the assistant start message
        if (prefill && this.currentAPI === 'moonshot') {
             apiMessages.push({
                 role: 'assistant',
                 content: prefill
             });
        }

        return apiMessages;
    }

    async callAPI(message, prefill) {
        const messages = this.buildMessagesForAPI(prefill);
        const endpoint = this.apiEndpoints[this.currentAPI];
        const apiKey = this.apiKeys[this.currentAPI];
        
        const requestBody = {
            model: this.currentModel,
            messages: messages,
            max_tokens: this.maxTokens, // Use user-defined max tokens
            temperature: 0.2,
            stream: false
        };

        const response = await fetch(endpoint, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${apiKey}`
            },
            body: JSON.stringify(requestBody)
        });

        if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            throw new Error(errorData.error?.message || `HTTP ${response.status}: ${response.statusText}`);
        }

        const data = await response.json();
        const content = data.choices[0]?.message?.content || 'No response received.';
        const tokenUsage = data.usage || {};
        const searchResults = data.search_results || [];
        const citations = data.citations || [];

        return { content, tokenUsage, searchResults, citations };
    }

    getSystemPrompt() {
        let basePrompt = '';
        if (this.currentPersona === 'customized') {
            basePrompt = this.customPrompt || 'You are a helpful AI assistant.';
        } else {
            basePrompt = this.personas[this.currentPersona]?.prompt || 'You are a helpful AI assistant.';
        }

        // Inject Feedback Loop Data if available for this chat
        if (this.feedbackLoops[this.currentChatId] && this.feedbackLoops[this.currentChatId].length > 0) {
            const feedbackList = this.feedbackLoops[this.currentChatId];
            let feedbackString = `\n\n[USER STYLE PREFERENCES]\nThe user has provided corrections to previous answers. Adapt your future responses to match the style and logic of the "Revised" versions below:\n`;
            
            feedbackList.forEach((item, index) => {
                feedbackString += `${index + 1}. ORIGINAL: "${item.original}" -> REVISED: "${item.revised}"\n`;
            });
            
            basePrompt += feedbackString;
        }

        return basePrompt;
    }

    // Extract References
    extractReferencesFromResponse(message) {
        const references = {};
        if (message.searchResults && message.searchResults.length > 0) {
            message.searchResults.forEach((result, index) => {
                const refNum = (index + 1).toString();
                references[refNum] = {
                    url: result.url,
                    title: result.title,
                    date: result.date,
                    snippet: result.snippet
                };
            });
        }
        if (message.citations && message.citations.length > 0) {
            message.citations.forEach((citation, index) => {
                const refNum = (index + 1).toString();
                if (!references[refNum]) {
                    references[refNum] = {
                        url: citation,
                        title: this.extractDomainFromUrl(citation),
                        date: null,
                        snippet: null
                    };
                }
            });
        }
        const contentRefs = this.extractReferencesFromContent(message.content);
        Object.assign(references, contentRefs);
        return references;
    }

    extractReferencesFromContent(content) {
        const references = {};
        const referencesSection = content.match(/References?:\s*([\s\S]*?)(?:\n\n|$)/i);
        if (referencesSection) {
            const refLines = referencesSection[1].split('\n');
            refLines.forEach(line => {
                const refMatch = line.match(/\[(\d+)\]\s*(.+)/);
                if (refMatch) {
                    const refNum = refMatch[1];
                    let url = refMatch[2].trim();
                    if (url.includes('http')) {
                        references[refNum] = {
                            url: url,
                            title: this.extractDomainFromUrl(url),
                            date: null,
                            snippet: null
                        };
                    }
                }
            });
        }
        return references;
    }

    extractDomainFromUrl(url) {
        try {
            return new URL(url).hostname;
        } catch (e) {
            return url;
        }
    }

    renderMessages() {
        this.messagesContainer.innerHTML = '';
        this.messages.forEach((message, index) => {
            const messageEl = this.createMessageElement(message, index);
            this.messagesContainer.appendChild(messageEl);
        });
        this.chatContainer.scrollTop = this.chatContainer.scrollHeight;
    }

    createMessageElement(message, index) {
        const messageEl = document.createElement('div');
        messageEl.className = `message ${message.role}`;
        
        const headerEl = document.createElement('div');
        headerEl.className = 'message-header';
        
        const roleEl = document.createElement('span');
        roleEl.className = 'message-role';
        roleEl.textContent = message.role === 'user' ? 'You' : 'Assistant';
        headerEl.appendChild(roleEl);

        const copyBtn = document.createElement('button');
        copyBtn.className = 'copy-btn';
        copyBtn.innerHTML = 'üìã';
        copyBtn.title = 'Copy message';
        copyBtn.addEventListener('click', () => this.copyMessage(message.content));
        headerEl.appendChild(copyBtn);

        const contentEl = document.createElement('div');
        contentEl.className = 'message-content';

        if (message.image && message.role === 'user') {
            const imgEl = document.createElement('img');
            imgEl.src = message.image;
            imgEl.className = 'message-image';
            imgEl.alt = 'Uploaded image';
            contentEl.appendChild(imgEl);
        }

        if (message.content) {
            if (message.role === 'assistant') {
                const msgReferences = this.extractReferencesFromResponse(message);
                Object.assign(this.references, msgReferences);
            }
            const renderedContent = this.renderEnhancedMarkdown(message.content);
            contentEl.innerHTML += renderedContent;
            
            if (message.role === 'assistant') {
                this.attachReferenceHandlers(contentEl);
            }
            if (window.hljs) {
                contentEl.querySelectorAll('pre code').forEach((block) => {
                    hljs.highlightBlock(block);
                });
            }
        }

        messageEl.appendChild(headerEl);
        messageEl.appendChild(contentEl);

        if (message.role === 'assistant' && message.tokenUsage) {
            const tokenUsageEl = this.createTokenUsageCornerElement(message.tokenUsage);
            messageEl.appendChild(tokenUsageEl);
        }

        return messageEl;
    }

    createTokenUsageCornerElement(tokenUsage) {
        const tokenEl = document.createElement('div');
        tokenEl.className = 'token-usage-corner';
        let tokenInfo = [];
        if (tokenUsage.total_tokens) tokenInfo.push(`${tokenUsage.total_tokens}T`);
        tokenEl.textContent = tokenInfo.length > 0 ? tokenInfo.join(' ‚Ä¢ ') : '';
        tokenEl.title = this.getDetailedTokenInfo(tokenUsage);
        return tokenEl;
    }

    getDetailedTokenInfo(tokenUsage) {
        let details = [];
        if (tokenUsage.prompt_tokens) details.push(`Input: ${tokenUsage.prompt_tokens}`);
        if (tokenUsage.completion_tokens) details.push(`Output: ${tokenUsage.completion_tokens}`);
        if (tokenUsage.total_tokens) details.push(`Total: ${tokenUsage.total_tokens}`);
        return details.join('\n');
    }

    renderEnhancedMarkdown(text) {
        let processedText = text;
        processedText = processedText.replace(/(^|\n)(\d+)\.\s/gm, '$1$2. ');
        let html = this.converter.makeHtml(processedText);
        html = html.replace(/<pre><code class="([^"]*)"([^>]*)>([\s\S]*?)<\/code><\/pre>/g, (match, langClass, attrs, code) => {
            const language = langClass ? langClass.replace('language-', '') : 'text';
            const codeId = 'code-' + Math.random().toString(36).substr(2, 9);
            return `<div class="code-block">
                <div class="code-header">
                    <span class="code-language">${language}</span>
                    <button class="code-copy-btn" onclick="copyCodeBlock('${codeId}')">Copy</button>
                </div>
                <pre><code id="${codeId}" class="${langClass}"${attrs}>${code}</code></pre>
            </div>`;
        });
        html = html.replace(/\[(\d+)\]/g, '<span class="reference-link" data-ref="$1">[$1]</span>');
        return html;
    }

    attachReferenceHandlers(contentEl) {
        const referenceLinks = contentEl.querySelectorAll('.reference-link');
        referenceLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                const refNum = e.target.dataset.ref;
                this.showReferencePopup(refNum);
            });
        });
    }

    showReferencePopup(refNum) {
        const reference = this.references[refNum];
        if (!reference) {
            this.showStatus('Reference not found', 'error');
            return;
        }
        this.currentReference = { num: refNum, ...reference };
        document.getElementById('referenceTitle').textContent = `Reference [${refNum}]`;
        let referenceContent = '';
        if (reference.title && reference.title !== reference.url) referenceContent += `<strong>Title:</strong> ${reference.title}<br>`;
        referenceContent += `<strong>URL:</strong> ${reference.url}`;
        if (reference.snippet) referenceContent += `<br><strong>Snippet:</strong> ${reference.snippet}`;
        document.getElementById('referenceUrl').innerHTML = referenceContent;
        this.referencePopup.classList.remove('hidden');
    }

    closeReferencePopup() {
        this.referencePopup.classList.add('hidden');
    }

    openReference() {
        if (this.currentReference.url) {
            window.open(this.currentReference.url, '_blank');
            this.closeReferencePopup();
        }
    }

    copyReference() {
        if (this.currentReference.url) {
            this.copyToClipboard(this.currentReference.url);
            this.showStatus('Reference URL copied', 'success');
            this.closeReferencePopup();
        }
    }

    async copyMessage(content) {
        await this.copyToClipboard(content);
        this.showStatus('Copied to clipboard', 'success');
    }

    async copyToClipboard(text) {
        try {
            await navigator.clipboard.writeText(text);
        } catch (error) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
        }
    }

    setLoading(loading) {
        this.isLoading = loading;
        this.sendMessage.disabled = loading;
        if (loading) {
            const loadingEl = document.createElement('div');
            loadingEl.className = 'message assistant loading-message';
            loadingEl.innerHTML = '<div class="loading">Loading response...</div>';
            this.messagesContainer.appendChild(loadingEl);
            this.chatContainer.scrollTop = this.chatContainer.scrollHeight;
        } else {
            const loadingMsg = document.querySelector('.loading-message');
            if (loadingMsg) loadingMsg.remove();
        }
    }

    showStatus(message, type = 'info') {
        this.statusIndicator.textContent = message;
        this.statusIndicator.className = `status status--${type} show`;
        setTimeout(() => {
            this.statusIndicator.classList.remove('show');
            this.statusIndicator.classList.add('hidden');
        }, 3000);
    }
}

window.copyCodeBlock = function(codeId) {
    const codeElement = document.getElementById(codeId);
    if (codeElement) {
        const text = codeElement.textContent;
        navigator.clipboard.writeText(text).then(() => {
            const codeBlock = codeElement.closest('.code-block');
            const copyBtn = codeBlock.querySelector('.code-copy-btn');
            if (copyBtn) {
                const originalText = copyBtn.textContent;
                copyBtn.textContent = 'Copied!';
                setTimeout(() => { copyBtn.textContent = originalText; }, 2000);
            }
        });
    }
};

document.addEventListener('DOMContentLoaded', () => {
    window.chatApp = new MultiAPIChat();
});
    </script>
<script type="module" src="/index.tsx"></script>
</body>
</html>